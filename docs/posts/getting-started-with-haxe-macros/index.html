<!DOCTYPE html> <html lang="en-CA"> <head> <meta charset="utf-8"> <meta name="viewport" content="width=device-width, initial-scale=1"> <title>Getting Started With Haxe Macros</title> <link rel="alternate" type="application/rss+xml" href="https://blog.hamaluik.ca/feed.rss" title="Posts RSS"> <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png"> <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png"> <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png"> <link rel="manifest" href="/site.webmanifest"> <link rel="mask-icon" href="/safari-pinned-tab.svg" color="#ff5555"> <meta name="msapplication-TileColor" content="#ff5555"> <meta name="theme-color" content="#ff5555"> <meta property="og:title" content="Getting Started With Haxe Macros"/> <meta property="og:url" content="http://blog.hamaluik.ca/posts/getting-started-with-haxe-macros/"/> <meta property="og:image" content="https://og-image.now.sh/Getting%20Started%20With%20Haxe%20Macros.png?theme=light&md=0&fontSize=75px&images=https%3A%2F%2Fassets.zeit.co%2Fimage%2Fupload%2Ffront%2Fassets%2Fdesign%2Fhyper-color-logo.svg&widths=350&heights=350"/> <meta property="og:description" content="Like has been said many times before, Haxe macros are incredibly powerful. They don&#x27;t always have the best documentation however, and I find a lot of people forgo their use entirely (instead doing things such as creating nodejs scripts to copy files around for building). Hopefully I can help shed some light on how to build your own macros for those who are new to the language, or macros in general. I&#x27;ll cover three macros I use on a regular basis, one each of the three types listed in the manual: an initialization macro for copying files to the build folder; a build macro for providing easy auto-completion of asset filenames (a la HaxeFlixel&#x27;s AssetPaths); and an expression macro for grabbing the build date as a Date object."/> <meta property="og:type" content="article"/> <meta property="og:locale" content="en_CA"/> <meta property="og:site_name" content="Kenton Hamaluik"/> <meta property="article:published_time" content=" 2016-10-12T07:00:00+00:00 "/> <meta property="article:author" content="http://blog.hamaluik.ca/"/> <meta property="article:tag" content="Haxe"/> <meta name="twitter:card" content="summary_large_image"/> <meta name="twitter:image:alt" content="Getting Started With Haxe Macros"/> <style> @font-face {font-family:"Crimson Pro";font-style:italic;font-weight:400;font-display:swap;src:local("Crimson Pro Italic"),local("CrimsonPro Italic"),local("Crimson-Pro-Italic"),local("CrimsonPro-Italic"),url(/fonts/crimson-pro-normal-latin-ext.woff2) format("woff2"),url(/fonts/CrimsonPro-Italic.ttf) format("ttf");unicode-range:U+0100-024F,U+0259,U+1E00-1EFF,U+2020,U+20A0-20AB,U+20AD-20CF,U+2113,U+2C60-2C7F,U+A720-A7FF;}@font-face {font-family:"Crimson Pro";font-style:italic;font-weight:400;font-display:swap;src:local("Crimson Pro Italic"),local("CrimsonPro Italic"),local("Crimson-Pro-Italic"),local("CrimsonPro-Italic"),url(/fonts/crimson-pro-italic-latin.woff2) format("woff2"),url(/fonts/CrimsonPro-Italic.ttf) format("ttf");unicode-range:U+0000-00FF,U+0131,U+0152-0153,U+02BB-02BC,U+02C6,U+02DA,U+02DC,U+2000-206F,U+2074,U+20AC,U+2122,U+2191,U+2193,U+2212,U+2215,U+FEFF,U+FFFD;}@font-face {font-family:"Crimson Pro";font-style:normal;font-weight:400;font-display:swap;src:local("Crimson Pro"),local("CrimsonPro"),local("Crimson-Pro"),local("CrimsonPro"),url(/fonts/crimson-pro-normal-latin-ext.woff2) format("woff2"),url(/fonts/CrimsonPro-Regular.ttf.ttf) format("ttf");unicode-range:U+0100-024F,U+0259,U+1E00-1EFF,U+2020,U+20A0-20AB,U+20AD-20CF,U+2113,U+2C60-2C7F,U+A720-A7FF;}@font-face {font-family:"Crimson Pro";font-style:normal;font-weight:400;font-display:swap;src:local("Crimson Pro"),local("CrimsonPro"),local("Crimson-Pro"),local("CrimsonPro"),url(/fonts/crimson-pro-normal-latin.woff2) format("woff2"),url(/fonts/CrimsonPro-Regular.ttf.ttf) format("ttf");unicode-range:U+0000-00FF,U+0131,U+0152-0153,U+02BB-02BC,U+02C6,U+02DA,U+02DC,U+2000-206F,U+2074,U+20AC,U+2122,U+2191,U+2193,U+2212,U+2215,U+FEFF,U+FFFD;}@font-face {font-family:"Crimson Pro";font-style:normal;font-weight:700;font-display:swap;src:local("Crimson Pro Bold"),local("CrimsonPro Bold"),local("Crimson-Pro-Bold"),local("CrimsonPro-Bold"),url(/fonts/crimson-pro-bold-latin-ext.woff2) format("woff2"),url(/fonts/CrimsonPro-Bold.ttf.ttf) format("ttf");unicode-range:U+0100-024F,U+0259,U+1E00-1EFF,U+2020,U+20A0-20AB,U+20AD-20CF,U+2113,U+2C60-2C7F,U+A720-A7FF;}@font-face {font-family:"Crimson Pro";font-style:normal;font-weight:700;font-display:swap;src:local("Crimson Pro Bold"),local("CrimsonPro Bold"),local("Crimson-Pro-Bold"),local("CrimsonPro-Bold"),url(/fonts/crimson-pro-bold-latin.woff2) format("woff2"),url(/fonts/CrimsonPro-Bold.ttf.ttf) format("ttf");unicode-range:U+0000-00FF,U+0131,U+0152-0153,U+02BB-02BC,U+02C6,U+02DA,U+02DC,U+2000-206F,U+2074,U+20AC,U+2122,U+2191,U+2193,U+2212,U+2215,U+FEFF,U+FFFD;}:root{--background-colour:#fafafa;--font-colour:#222;--footer-colour:#222;--link-colour:#076678;--visited-colour:#8f3f71;--theme-background:#282a36;--theme-currentline:#44475a;--theme-selection:#44475a;--theme-foreground:#f8f8f2;--theme-comment:#6272a4;--theme-cyan:#8be9fd;--theme-green:#50fa7b;--theme-orange:#ffb86c;--theme-pink:#ff79c6;--theme-purple:#bd93f9;--theme-red:#ff5555;--theme-yellow:#f1fa8c;}*{box-sizing:border-box;margin:0;}body{display:flex;flex-direction:column;min-height:100vh;padding:1rem clamp(1rem,5vw,3rem) 1rem;font-family:"Crimson Pro",Constantia,"Lucida Bright",Lucidabright,"Lucida Serif",Lucida,"DejaVu Serif","Bitstream Vera Serif","Liberation Serif",Georgia,serif;font-size:16pt;line-height:1.5;color:var(--font-colour);background:var(--background-colour);}body>*{--layout-spacing:max(2vh,2rem);width:100%;max-width:70ch;margin-left:auto;margin-right:auto;}main{margin-top:var(--layout-spacing);}footer{margin-top:auto;padding-top:var(--layout-spacing);}footer p{border-top:1px solid var(--footer-colour);padding-top:0.25em;font-size:0.9rem;color:var(--footer-colour);display:flex;justify-content:space-between;}:is(h1,h2,h3){line-height:1.2;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,sans-serif,BlinkMacSystemFont,Helvetica Neue;}:is(h2,h3,figure):not(:first-child){margin-top:2em;}article*+*{margin-top:1em;}li>a{text-decoration:none;}a{word-break:break-all;color:var(--link-colour);text-underline-offset:0.15em;}a:visited{color:var(--visited-colour);}:not(pre)>code{word-break:break-all;font-family:"Source Code Pro","Fira Code","Fira Mono",Consolas,"Andale Mono WT","Andale Mono","Lucida Console","Lucida Sans Typewriter","DejaVu Sans Mono","Bitstream Vera Sans Mono","Liberation Mono","Nimbus Mono L",Monaco,"Courier New",Courier,monospace;font-size:12pt;}pre,figure{overflow-x:auto;}figure{display:flex;flex-direction:column;align-items:center;justify-content:center;max-width:100%;}figure>a>img,figure>img,figure>video{max-width:100%;margin:0 auto;}figure figcaption{font-size:0.8rem;text-align:center;}time{font-size:0.8rem;}header h1 a{color:var(--font-colour);font-size:4rem;font-weight:bold;word-break:normal;}header h1 a:visited{color:var(--font-colour);}svg{color:var(--font-colour);fill:currentColor;}img.white{mix-blend-mode:multiply;}.highlight{font-family:"Source Code Pro","Fira Code","Fira Mono",Consolas,"Andale Mono WT","Andale Mono","Lucida Console","Lucida Sans Typewriter","DejaVu Sans Mono","Bitstream Vera Sans Mono","Liberation Mono","Nimbus Mono L",Monaco,"Courier New",Courier,monospace;font-size:12pt;padding:0.25em;margin:1em 0;}.highlight .hll{background-color:#ffffcc;}.highlight{background:#282828;color:#ebdbb2;background-color:#282828;}.highlight .c{color:#928374;font-style:italic;background-color:#282828;}.highlight .err{color:#ebdbb2;background-color:#282828;}.highlight .esc{color:#ebdbb2;background-color:#282828;}.highlight .g{color:#ebdbb2;background-color:#282828;}.highlight .k{color:#fe8019;background-color:#282828;}.highlight .l{color:#ebdbb2;background-color:#282828;}.highlight .n{color:#ebdbb2;background-color:#282828;}.highlight .o{color:#fe8019;background-color:#282828;}.highlight .x{color:#ebdbb2;background-color:#282828;}.highlight .p{color:#ebdbb2;background-color:#282828;}.highlight .ch{color:#928374;font-style:italic;background-color:#282828;}.highlight .cm{color:#928374;font-style:italic;background-color:#282828;}.highlight .cp{color:#8ec07c;background-color:#282828;}.highlight .c1{color:#928374;font-style:italic;background-color:#282828;}.highlight .cs{color:#928374;font-style:italic;background-color:#282828;}.highlight .gd{color:#282828;background-color:#fb4934;}.highlight .ge{color:#83a598;text-decoration:underline;background-color:#282828;}.highlight .gr{color:#ebdbb2;font-weight:bold;background-color:#fb4934;}.highlight .gh{color:#b8bb26;font-weight:bold;background-color:#282828;}.highlight .gi{color:#282828;background-color:#b8bb26;}.highlight .go{color:#504945;background-color:#282828;}.highlight .gp{color:#ebdbb2;background-color:#282828;}.highlight .gs{color:#ebdbb2;background-color:#282828;}.highlight .gu{color:#b8bb26;font-weight:bold;background-color:#282828;}.highlight .gt{color:#ebdbb2;font-weight:bold;background-color:#fb4934;}.highlight .kc{color:#fe8019;background-color:#282828;}.highlight .kd{color:#fe8019;background-color:#282828;}.highlight .kn{color:#fe8019;background-color:#282828;}.highlight .kp{color:#fe8019;background-color:#282828;}.highlight .kr{color:#fe8019;background-color:#282828;}.highlight .kt{color:#fabd2f;background-color:#282828;}.highlight .ld{color:#ebdbb2;background-color:#282828;}.highlight .m{color:#d3869b;background-color:#282828;}.highlight .s{color:#b8bb26;background-color:#282828;}.highlight .na{color:#b8bb26;font-weight:bold;background-color:#282828;}.highlight .nb{color:#fabd2f;background-color:#282828;}.highlight .nc{color:#ebdbb2;background-color:#282828;}.highlight .no{color:#d3869b;background-color:#282828;}.highlight .nd{color:#ebdbb2;background-color:#282828;}.highlight .ni{color:#fabd2f;background-color:#282828;}.highlight .ne{color:#fb4934;background-color:#282828;}.highlight .nf{color:#fabd2f;background-color:#282828;}.highlight .nl{color:#fb4934;background-color:#282828;}.highlight .nn{color:#ebdbb2;background-color:#282828;}.highlight .nx{color:#ebdbb2;background-color:#282828;}.highlight .py{color:#ebdbb2;background-color:#282828;}.highlight .nt{color:#fb4934;background-color:#282828;}.highlight .nv{color:#ebdbb2;background-color:#282828;}.highlight .ow{color:#fe8019;background-color:#282828;}.highlight .w{color:#ebdbb2;background-color:#282828;}.highlight .mb{color:#d3869b;background-color:#282828;}.highlight .mf{color:#d3869b;background-color:#282828;}.highlight .mh{color:#d3869b;background-color:#282828;}.highlight .mi{color:#d3869b;background-color:#282828;}.highlight .mo{color:#d3869b;background-color:#282828;}.highlight .sb{color:#b8bb26;background-color:#282828;}.highlight .sc{color:#b8bb26;background-color:#282828;}.highlight .sd{color:#b8bb26;background-color:#282828;}.highlight .s2{color:#b8bb26;background-color:#282828;}.highlight .se{color:#b8bb26;background-color:#282828;}.highlight .sh{color:#b8bb26;background-color:#282828;}.highlight .si{color:#b8bb26;background-color:#282828;}.highlight .sx{color:#b8bb26;background-color:#282828;}.highlight .sr{color:#b8bb26;background-color:#282828;}.highlight .s1{color:#b8bb26;background-color:#282828;}.highlight .ss{color:#83a598;background-color:#282828;}.highlight .bp{color:#fabd2f;background-color:#282828;}.highlight .vc{color:#ebdbb2;background-color:#282828;}.highlight .vg{color:#ebdbb2;background-color:#282828;}.highlight .vi{color:#ebdbb2;background-color:#282828;}.highlight .il{color:#d3869b;background-color:#282828;}.slideshow{width:100%;}.slideshow .slides{display:grid;grid-auto-flow:column;grid-gap:1.5rem;overflow-x:auto;scroll-snap-type:x mandatory;padding:0 0 1.5rem;-webkit-overflow-scrolling:touch;}.slideshow .slides>*{width:min(45ch,60vw);height:auto;scroll-snap-align:center;scroll-snap-stop:always;}</style> </head> <body> <header> <h1><a href="https://blog.hamaluik.ca/">Kenton Hamaluik</a></h1> </header> <main> <article> <header> <h1> Getting Started With Haxe Macros <time datetime='2016-10-12T07:00:00+00:00'>(2016-10-12)</time> </h1> </header> <p>Like has been said many times before, <a href="http://haxe.org/">Haxe</a> macros are incredibly powerful. They don’t always have the best documentation however, and I find a lot of people forgo their use entirely (instead doing things such as creating <a href="https://nodejs.org/">nodejs</a> scripts to copy files around for building). Hopefully I can help shed some light on how to build your own macros for those who are new to the language, or macros in general. I’ll cover three macros I use on a regular basis, one each of the three types listed in the <a href="https://haxe.org/manual/macro.html">manual</a>:</p> <ol> <li>An <a href="#initmacros"><strong>initialization macro</strong></a> for copying files to the build folder</li> <li>A <a href="#buildmacros"><strong>build macro</strong></a> for providing easy auto-completion of asset filenames (a la <a href="http://haxeflixel.com/">HaxeFlixel</a>’s <code>AssetPaths</code>)</li> <li>An <a href="#exprmacros"><strong>expression macro</strong></a> for grabbing the build date as a <code>Date</code> object.</li> </ol> <p>Before I dive into the macros, it may help to define exactly what Haxe macros are—basically, Haxe macros are just Haxe code that gets run at compile time, rather than run time. Because the code is executed during your project’s compilation phase, macros thus have the ability to transform the code that is getting compiled (generally by modifying the abstract syntax tree). Macros allow you to create, programmatically, anything that you could create manually in normal Haxe source code files. For example, if you are really ambitious, you could create macros to create entire classes based off of a <code>.json</code> (or whatever other format floats your boat) description file. Or, you can automatically inject function calls into your code to create a <a href="https://blog.hamaluik.ca/posts/creating-a-code-profiler-in-haxe-using-macros/">rudimentary profiler</a>, or even implement <a href="https://en.wikipedia.org/wiki/Aspect-oriented_programming">aspect-oriented programming</a>. Or you can just use them to translate some definition variables into a string that gets used without runtime overhead. Haxe macros are similar-<em>ish</em> to <a href="https://msdn.microsoft.com/en-us/library/503x3e3s.aspx">C/C++ Macros</a>, just <em>orders of magnitude</em> more powerful.</p> <h2><a href="#initialization-macros" aria-hidden="true" class="anchor" id="headerinitialization-macros"></a><a name="initmacros"></a>Initialization Macros</h2> <p>Initialization macros are just functions that you call in your <code>.hxml</code> file by using the <code>--macro</code> <a href="https://haxe.org/manual/compiler-usage-flags.html">parameter</a> (note that this means you can easily include them in libraries using <a href="https://haxe.org/manual/haxelib-extraParams.html">extraParams.hxml</a>!). In order to better explain these macros to you, I will go through creating the macro that I often use to copy files from one directory to another. This is very useful for things such as games, where you want to copy the production-ready versions of assets from a “source” directory, into your binary directory so that when you run the game, it has access to those assets.</p> <p>I like to keep my projects organized in namespaces describing groups of functionality, so I usually end up with a <code>macros</code> package. For this example, let’s create the <code>macros</code> package:</p> <div class="highlight"><pre><span></span>mkdir src
mkdir src/macros
</pre></div> <p>And in that package, create a file called <code>AssetManagement.hx</code>, which will be a container class for several macro functions dealing with copying asset files around:</p> <div class="highlight"><pre><span></span><span class="kn">package</span><span class="w"> </span><span class="nn">macros</span><span class="p">;</span><span class="w"></span>

<span class="kd">class</span><span class="w"> </span><span class="n">AssetManagement</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nf">copyProjectAssets</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">trace</span><span class="p">(</span><span class="s2">&quot;Hello from copyProjectAssets()!&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div> <p>Now, to call this function in your <code>.hxml</code> file, simply include the line <code>--macro macros.AssetManagement.copyProjectAssets()</code>:</p> <div class="highlight"><pre><span></span><span class="p">-</span><span class="k">cp</span><span class="w"> </span><span class="s">src</span>

<span class="err">--macro macros.AssetManagement.copyProjectAssets()</span>

<span class="p">-</span><span class="k">neko</span><span class="w"> </span><span class="s">bin/init.n</span>
</pre></div> <p>Compiling this now won’t do much other than notify you that we did indeed run the function:</p> <div class="highlight"><pre><span></span>$ haxe init.hxml
src/macros/AssetManagement.hx:5: Hello from copyProjectAssets<span class="o">()</span>!
</pre></div> <p>It’s important to note that while our macro is executing, it has access to pretty much the entire Haxe standard library. We can use that standard library to do things like interact with the file system, which is what we care about in this example. Let’s get started by using <code>Sys</code> and <code>Path</code> to figure out our source and destination folders:</p> <div class="highlight"><pre><span></span><span class="kn">package</span><span class="w"> </span><span class="nn">macros</span><span class="p">;</span><span class="w"></span>

<span class="kn">import</span><span class="w"> </span><span class="nn">Sys</span><span class="p">;</span><span class="w"></span>
<span class="kn">import</span><span class="w"> </span><span class="nn">haxe</span><span class="p">.</span><span class="nn">io</span><span class="p">.</span><span class="nn">Path</span><span class="p">;</span><span class="w"></span>

<span class="kd">class</span><span class="w"> </span><span class="n">AssetManagement</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nf">copyProjectAssets</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="kd">var</span><span class="w"> </span>cwd<span class="p">:</span><span class="n">String</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Sys</span><span class="p">.</span><span class="n">getCwd</span><span class="p">();</span><span class="w"></span>
<span class="w">        </span><span class="kd">var</span><span class="w"> </span>assetSrcFolder<span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Path</span><span class="p">.</span><span class="n">join</span><span class="p">([</span><span class="n">cwd</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;src&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;assets&quot;</span><span class="p">]);</span><span class="w"></span>
<span class="w">        </span><span class="kd">var</span><span class="w"> </span>assetsDstFolder<span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Path</span><span class="p">.</span><span class="n">join</span><span class="p">([</span><span class="n">cwd</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;bin&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;assets&quot;</span><span class="p">]);</span><span class="w"></span>

<span class="w">        </span><span class="n">Sys</span><span class="p">.</span><span class="n">println</span><span class="p">(</span><span class="s2">&quot;I am going to copy files from:&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="n">Sys</span><span class="p">.</span><span class="n">println</span><span class="p">(</span><span class="s2">&quot;  &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">assetSrcFolder</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="n">Sys</span><span class="p">.</span><span class="n">println</span><span class="p">(</span><span class="s2">&quot;to:&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="n">Sys</span><span class="p">.</span><span class="n">println</span><span class="p">(</span><span class="s2">&quot;  &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">assetsDstFolder</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div> <p>Which when compiled, results in:</p> <div class="highlight"><pre><span></span>$ haxe init.hxml
I am going to copy files from:
  /home/kenton/Projects/macro-demos/src/assets
to:
  /home/kenton/Projects/macro-demos/bin/assets
</pre></div> <p>Our function can also call other static functions in the class—in this case, a recursive file copy function (which simply uses the standard library to copy an entire directory somewhere, including all subdirectories):</p> <div class="highlight"><pre><span></span><span class="kd">private</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nf">copy</span><span class="p">(</span><span class="n">sourceDir</span><span class="p">:</span><span class="n">String</span><span class="p">,</span><span class="w"> </span><span class="n">targetDir</span><span class="p">:</span><span class="n">String</span><span class="p">):</span><span class="n">Int</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">var</span><span class="w"> </span>numCopied<span class="p">:</span><span class="n">Int</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"></span>

<span class="w">    </span><span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">FileSystem</span><span class="p">.</span><span class="n">exists</span><span class="p">(</span><span class="n">targetDir</span><span class="p">))</span><span class="w"></span>
<span class="w">        </span><span class="n">FileSystem</span><span class="p">.</span><span class="n">createDirectory</span><span class="p">(</span><span class="n">targetDir</span><span class="p">);</span><span class="w"></span>

<span class="w">    </span><span class="k">for</span><span class="p">(</span><span class="n">entry</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">FileSystem</span><span class="p">.</span><span class="n">readDirectory</span><span class="p">(</span><span class="n">sourceDir</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="kd">var</span><span class="w"> </span>srcFile<span class="p">:</span><span class="n">String</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Path</span><span class="p">.</span><span class="n">join</span><span class="p">([</span><span class="n">sourceDir</span><span class="p">,</span><span class="w"> </span><span class="n">entry</span><span class="p">]);</span><span class="w"></span>
<span class="w">        </span><span class="kd">var</span><span class="w"> </span>dstFile<span class="p">:</span><span class="n">String</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Path</span><span class="p">.</span><span class="n">join</span><span class="p">([</span><span class="n">targetDir</span><span class="p">,</span><span class="w"> </span><span class="n">entry</span><span class="p">]);</span><span class="w"></span>

<span class="w">        </span><span class="k">if</span><span class="p">(</span><span class="n">FileSystem</span><span class="p">.</span><span class="n">isDirectory</span><span class="p">(</span><span class="n">srcFile</span><span class="p">))</span><span class="w"></span>
<span class="w">            </span><span class="n">numCopied</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">copy</span><span class="p">(</span><span class="n">srcFile</span><span class="p">,</span><span class="w"> </span><span class="n">dstFile</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="n">File</span><span class="p">.</span><span class="n">copy</span><span class="p">(</span><span class="n">srcFile</span><span class="p">,</span><span class="w"> </span><span class="n">dstFile</span><span class="p">);</span><span class="w"></span>
<span class="w">            </span><span class="n">numCopied</span><span class="o">++</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">numCopied</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div> <p>Using this function, we can modify our original macro to copy from our source to build destinations whenever we build the project:</p> <div class="highlight"><pre><span></span><span class="kn">package</span><span class="w"> </span><span class="nn">macros</span><span class="p">;</span><span class="w"></span>

<span class="kn">import</span><span class="w"> </span><span class="nn">Sys</span><span class="p">;</span><span class="w"></span>
<span class="kn">import</span><span class="w"> </span><span class="nn">haxe</span><span class="p">.</span><span class="nn">io</span><span class="p">.</span><span class="nn">Path</span><span class="p">;</span><span class="w"></span>

<span class="kd">class</span><span class="w"> </span><span class="n">AssetManagement</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nf">copy</span><span class="p">(</span><span class="n">sourceDir</span><span class="p">:</span><span class="n">String</span><span class="p">,</span><span class="w"> </span><span class="n">targetDir</span><span class="p">:</span><span class="n">String</span><span class="p">):</span><span class="n">Int</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="kd">var</span><span class="w"> </span>numCopied<span class="p">:</span><span class="n">Int</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"></span>

<span class="w">        </span><span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">FileSystem</span><span class="p">.</span><span class="n">exists</span><span class="p">(</span><span class="n">targetDir</span><span class="p">))</span><span class="w"></span>
<span class="w">            </span><span class="n">FileSystem</span><span class="p">.</span><span class="n">createDirectory</span><span class="p">(</span><span class="n">targetDir</span><span class="p">);</span><span class="w"></span>

<span class="w">        </span><span class="k">for</span><span class="p">(</span><span class="n">entry</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">FileSystem</span><span class="p">.</span><span class="n">readDirectory</span><span class="p">(</span><span class="n">sourceDir</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="kd">var</span><span class="w"> </span>srcFile<span class="p">:</span><span class="n">String</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Path</span><span class="p">.</span><span class="n">join</span><span class="p">([</span><span class="n">sourceDir</span><span class="p">,</span><span class="w"> </span><span class="n">entry</span><span class="p">]);</span><span class="w"></span>
<span class="w">            </span><span class="kd">var</span><span class="w"> </span>dstFile<span class="p">:</span><span class="n">String</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Path</span><span class="p">.</span><span class="n">join</span><span class="p">([</span><span class="n">targetDir</span><span class="p">,</span><span class="w"> </span><span class="n">entry</span><span class="p">]);</span><span class="w"></span>

<span class="w">            </span><span class="k">if</span><span class="p">(</span><span class="n">FileSystem</span><span class="p">.</span><span class="n">isDirectory</span><span class="p">(</span><span class="n">srcFile</span><span class="p">))</span><span class="w"></span>
<span class="w">                </span><span class="n">numCopied</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">copy</span><span class="p">(</span><span class="n">srcFile</span><span class="p">,</span><span class="w"> </span><span class="n">dstFile</span><span class="p">);</span><span class="w"></span>
<span class="w">            </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                </span><span class="n">File</span><span class="p">.</span><span class="n">copy</span><span class="p">(</span><span class="n">srcFile</span><span class="p">,</span><span class="w"> </span><span class="n">dstFile</span><span class="p">);</span><span class="w"></span>
<span class="w">                </span><span class="n">numCopied</span><span class="o">++</span><span class="p">;</span><span class="w"></span>
<span class="w">            </span><span class="p">}</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">numCopied</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nf">copyProjectAssets</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="kd">var</span><span class="w"> </span>cwd<span class="p">:</span><span class="n">String</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Sys</span><span class="p">.</span><span class="n">getCwd</span><span class="p">();</span><span class="w"></span>
<span class="w">        </span><span class="kd">var</span><span class="w"> </span>assetSrcFolder<span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Path</span><span class="p">.</span><span class="n">join</span><span class="p">([</span><span class="n">cwd</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;src&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;assets&quot;</span><span class="p">]);</span><span class="w"></span>
<span class="w">        </span><span class="kd">var</span><span class="w"> </span>assetsDstFolder<span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Path</span><span class="p">.</span><span class="n">join</span><span class="p">([</span><span class="n">cwd</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;bin&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;assets&quot;</span><span class="p">]);</span><span class="w"></span>

<span class="w">        </span><span class="c1">// make sure the assets folder exists</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">FileSystem</span><span class="p">.</span><span class="n">exists</span><span class="p">(</span><span class="n">assetsDstFolder</span><span class="p">))</span><span class="w"></span>
<span class="w">            </span><span class="n">FileSystem</span><span class="p">.</span><span class="n">createDirectory</span><span class="p">(</span><span class="n">assetsDstFolder</span><span class="p">);</span><span class="w"></span>

<span class="w">        </span><span class="c1">// copy it!</span><span class="w"></span>
<span class="w">        </span><span class="kd">var</span><span class="w"> </span>numCopied<span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">copy</span><span class="p">(</span><span class="n">assetSrcFolder</span><span class="p">,</span><span class="w"> </span><span class="n">assetsDstFolder</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="n">Sys</span><span class="p">.</span><span class="n">println</span><span class="p">(</span><span class="s1">&#39;Copied </span><span class="si">${</span><span class="n">numCopied</span><span class="si">}</span><span class="s1"> project assets to </span><span class="si">${</span><span class="n">assetsDstFolder</span><span class="si">}</span><span class="s1">!&#39;</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div> <p>And there we go! Now whenever we build, our assets folder will be copied in full:</p> <div class="highlight"><pre><span></span>$ haxe init.hxml
Copied <span class="m">5</span> project assets to /home/kenton/Projects/macro-demos/bin/assets!
</pre></div> <h2><a href="#build-macros" aria-hidden="true" class="anchor" id="headerbuild-macros"></a><a name="buildmacros"></a>Build Macros</h2> <p>Build macros are special macros that automatically get executed by the compiler when compiling <code>class</code>es, <code>enum</code>s, and <code>abstract</code>s. Their purpose is generally to modify the structure of the compiled code as it is compiled—think adding, removing, and changing the fields of a class. I previously wrote about build macros in my post about <a href="https://blog.hamaluik.ca/posts/creating-a-code-profiler-in-haxe-using-macros/">creating a code profiler</a>, but in short a build macro could dynamically convert a class that looks like this:</p> <div class="highlight"><pre><span></span><span class="kn">package</span><span class="p">;</span><span class="w"></span>

<span class="nd">@:build(</span><span class="n">macros</span><span class="p">.</span><span class="n">MyTransformer</span><span class="p">.</span><span class="n">transform</span><span class="p">()</span><span class="nd">)</span><span class="w"></span>
<span class="kd">class</span><span class="w"> </span><span class="n">MyClass</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kd">var</span><span class="w"> </span>a<span class="p">:</span><span class="n">String</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kd">var</span><span class="w"> </span>b<span class="p">:</span><span class="n">Int</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div> <p>into this:</p> <div class="highlight"><pre><span></span><span class="kn">package</span><span class="p">;</span><span class="w"></span>

<span class="kd">class</span><span class="w"> </span><span class="n">MyClass</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kd">var</span><span class="w"> </span>b<span class="p">:</span><span class="n">Int</span><span class="p">;</span><span class="w"></span>

<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nf">squared</span><span class="p">():</span><span class="n">Int</span><span class="w"> </span><span class="n">x</span><span class="o">*</span><span class="n">x</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div> <p>(in this example we removed <code>a</code>, changed <code>b</code> to be public and static, and added a function named <code>squared</code>).</p> <p>Aside from contrived examples such as this, I find that I most commonly use build macros in my own projects to tie into the asset copying system described above. When developing game code, I found myself often needing to include specific asset files, and ended up with constants like <code>public static var enemySpriteFileName:String = &quot;assets/sprites/enemy.png&quot;;</code> littered throughout my code. When you start getting a lot of assets this very quickly becomes not feasible. Further, you don’t get any protection from all-too-common things like mistyping that one file name and inexplicably having some broken system. To remedy some of these issues, HaxeFlixel has a handy utility which I fell in love with and copy in all of my projects these days. Basically, a macro adds a list of <code>public static</code> strings to a class which point to specific asset file names. No more typos, and you even benefit from auto-completion.</p> <p>To do this in your own project, get started by creating an empty class which will hold the file name strings:</p> <div class="highlight"><pre><span></span><span class="kn">package</span><span class="p">;</span><span class="w"></span>

<span class="nd">@:build(</span><span class="n">macros</span><span class="p">.</span><span class="n">Assets</span><span class="p">.</span><span class="n">addAssetList</span><span class="p">()</span><span class="nd">)</span><span class="w"></span>
<span class="kd">class</span><span class="w"> </span><span class="n">AssetFiles</span><span class="w"> </span><span class="p">{}</span><span class="w"></span>
</pre></div> <p>The only unique thing here is the line <code>@:build(macros.Assets.addAssetList())</code>. This is some custom <a href="https://haxe.org/manual/lf-metadata.html">metadata</a> which tells the compiler to run the <code>addAssetList()</code> function while <em>typing</em> the <code>AssetFiles</code> class. We should create that function now:</p> <div class="highlight"><pre><span></span><span class="kn">package</span><span class="w"> </span><span class="nn">macros</span><span class="p">;</span><span class="w"></span>

<span class="kn">import</span><span class="w"> </span><span class="nn">haxe</span><span class="p">.</span><span class="nn">macro</span><span class="p">.</span><span class="nn">Context</span><span class="p">;</span><span class="w"></span>
<span class="kn">import</span><span class="w"> </span><span class="nn">haxe</span><span class="p">.</span><span class="nn">macro</span><span class="p">.</span><span class="nn">Expr</span><span class="p">;</span><span class="w"></span>
<span class="kn">import</span><span class="w"> </span><span class="nn">Sys</span><span class="p">;</span><span class="w"></span>
<span class="kn">import</span><span class="w"> </span><span class="nn">haxe</span><span class="p">.</span><span class="nn">io</span><span class="p">.</span><span class="nn">Path</span><span class="p">;</span><span class="w"></span>

<span class="kd">class</span><span class="w"> </span><span class="n">Assets</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nf">addAssetList</span><span class="p">():</span><span class="n">Array</span><span class="p">&lt;</span><span class="n">Field</span><span class="p">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="c1">// get all the fields in the class at this point</span><span class="w"></span>
<span class="w">        </span><span class="c1">// this is an array describing the variables, properties,</span><span class="w"></span>
<span class="w">        </span><span class="c1">// and methods in the class.</span><span class="w"></span>
<span class="w">        </span><span class="kd">var</span><span class="w"> </span>fields<span class="p">:</span><span class="n">Array</span><span class="p">&lt;</span><span class="n">Field</span><span class="p">&gt;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Context</span><span class="p">.</span><span class="n">getBuildFields</span><span class="p">();</span><span class="w"></span>

<span class="w">        </span><span class="c1">// TODO: modify the fields</span><span class="w"></span>

<span class="w">        </span><span class="c1">// and we&#39;re done</span><span class="w"></span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">fields</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div> <p>Right now this class will get the list of build fields, do nothing to it, and return. Basically, it does nothing. What we want it do is change the <code>AssetFiles</code> class into the following (assuming we have the files <code>sprites/enemy.png</code> and <code>sounds/hit.ogg</code> in our assets folder):</p> <div class="highlight"><pre><span></span><span class="kn">package</span><span class="p">;</span><span class="w"></span>

<span class="kd">class</span><span class="w"> </span><span class="n">AssetFiles</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">   </span><span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kd">var</span><span class="w"> </span>asset___sprites___enemy__png<span class="p">:</span><span class="n">String</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;assets/sprites/enemy.png&quot;</span><span class="p">;</span><span class="w"></span>
<span class="w">   </span><span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kd">var</span><span class="w"> </span>asset___sounds___hut__ogg<span class="p">:</span><span class="n">String</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;assets/sounds/hit.ogg&quot;</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div> <p>Let’s get started by listing all our files:</p> <div class="highlight"><pre><span></span><span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nf">addAssetList</span><span class="p">():</span><span class="n">Array</span><span class="p">&lt;</span><span class="n">Field</span><span class="p">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="c1">// get all the fields in the class at this point</span><span class="w"></span>
<span class="w">    </span><span class="c1">// this is an array describing the variables, properties,</span><span class="w"></span>
<span class="w">    </span><span class="c1">// and methods in the class.</span><span class="w"></span>
<span class="w">    </span><span class="kd">var</span><span class="w"> </span>fields<span class="p">:</span><span class="n">Array</span><span class="p">&lt;</span><span class="n">Field</span><span class="p">&gt;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Context</span><span class="p">.</span><span class="n">getBuildFields</span><span class="p">();</span><span class="w"></span>

<span class="w">    </span><span class="c1">// recursively get a list of all files in our assets folder</span><span class="w"></span>
<span class="w">    </span><span class="kd">var</span><span class="w"> </span>assetSrcFolder<span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Path</span><span class="p">.</span><span class="n">join</span><span class="p">([</span><span class="n">Sys</span><span class="p">.</span><span class="n">getCwd</span><span class="p">(),</span><span class="w"> </span><span class="s2">&quot;src&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;assets&quot;</span><span class="p">]);</span><span class="w"></span>
<span class="w">    </span><span class="kd">var</span><span class="w"> </span>files<span class="p">:</span><span class="n">Array</span><span class="p">&lt;</span><span class="n">String</span><span class="p">&gt;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">listFiles</span><span class="p">(</span><span class="n">assetSrcFolder</span><span class="p">);</span><span class="w"></span>

<span class="w">    </span><span class="c1">// add the fields to the class</span><span class="w"></span>
<span class="w">    </span><span class="k">for</span><span class="p">(</span><span class="n">file</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">files</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="kd">var</span><span class="w"> </span>relativePath<span class="p">:</span><span class="n">String</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">file</span><span class="p">.</span><span class="n">substr</span><span class="p">(</span><span class="n">assetSrcFolder</span><span class="p">.</span><span class="n">length</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="c1">// map characters not allowed in variable names to ones that are</span><span class="w"></span>
<span class="w">        </span><span class="kd">var</span><span class="w"> </span>name<span class="p">:</span><span class="n">String</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;asset___&quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">relativePath</span><span class="p">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">).</span><span class="n">join</span><span class="p">(</span><span class="s2">&quot;___&quot;</span><span class="p">).</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;-&quot;</span><span class="p">).</span><span class="n">join</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">).</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">).</span><span class="n">join</span><span class="p">(</span><span class="s2">&quot;__&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="n">relativePath</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;assets/&quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">relativePath</span><span class="p">;</span><span class="w"></span>

<span class="w">        </span><span class="c1">// TODO: add a public static var string field called `name` with a value of `relativePath`</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="c1">// and we&#39;re done</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">fields</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div> <p>Now that we have an entry for each file, let’s construct the fields. When I was first getting started with macros, I found this bit to be by far the most confusing. Thankfully, the <a href="http://api.haxe.org/haxe/macro/">api docs</a> have improved a bit since then, but the main thing to remember is that the fields at this point are basically just anonymous structures filled with <a href="https://haxe.org/manual/types-enum-instance.html"><code>enum</code> values</a>. Specifically, we need to fill out the following typedef:</p> <div class="highlight"><pre><span></span><span class="kd">typedef</span><span class="w"> </span><span class="n">Field</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">var</span><span class="w"> </span>name<span class="p">:</span><span class="n">String</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="nd">@:optional</span><span class="w"> </span><span class="kd">var</span><span class="w"> </span>doc<span class="p">:</span><span class="n">Null</span><span class="p">&lt;</span><span class="n">String</span><span class="p">&gt;;</span><span class="w"></span>
<span class="w">    </span><span class="nd">@:optional</span><span class="w"> </span><span class="kd">var</span><span class="w"> </span>access<span class="p">:</span><span class="n">Array</span><span class="p">&lt;</span><span class="n">Access</span><span class="p">&gt;;</span><span class="w"></span>
<span class="w">    </span><span class="kd">var</span><span class="w"> </span>kind<span class="p">:</span><span class="n">FieldType</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="kd">var</span><span class="w"> </span>pos<span class="p">:</span><span class="n">Position</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="nd">@:optional</span><span class="w"> </span><span class="kd">var</span><span class="w"> </span>meta<span class="p">:</span><span class="n">Metadata</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div> <p>In the <code>Field</code> typedef,</p> <dl> <dt><code>name</code></dt> <dd>refers to the variable / property / function name. In this case, it's the sanitized file name (<code>asset___sprites___enemy__png</code> in the above example.)</dd> <dt><code>doc</code></dt> <dd>is an optional documentation string used for autocomplete and such</dd> <dt><code>access</code></dt> <dd>is an array of <a href="http://api.haxe.org/haxe/macro/Access.html">access modifier enums</a> describing whether the field is private / public, etc.</dd> <dt><code>kind</code></dt> <dd>is the meat of the field, and is an enum describing the field: be it a variable, property, or function, along with its value (which is itself an "expression" [which is just code])</dd> <dt><code>pos</code></dt> <dd>is a variable describing where in your file the field is. If you get an error, this describes the file and line number it occurs, for instance.</dd> <dt><code>meta</code></dt> <dd>is an array of <a href="http://api.haxe.org/haxe/macro/MetadataEntry.html">metadata entries</a> for the field</dd> </dl> <p>Here’s how we can construct the field (note that we don’t include a <code>meta</code> field; this is because it is <code>@:optional</code> in the typedef, and we don’t need it—not including it is equivalent to passing <code>null</code> for it):</p> <div class="highlight"><pre><span></span><span class="c1">// add the fields to the class</span><span class="w"></span>
<span class="k">for</span><span class="p">(</span><span class="n">file</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">files</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">var</span><span class="w"> </span>relativePath<span class="p">:</span><span class="n">String</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">file</span><span class="p">.</span><span class="n">substr</span><span class="p">(</span><span class="n">assetSrcFolder</span><span class="p">.</span><span class="n">length</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="c1">// map characters not allowed in variable names to ones that are</span><span class="w"></span>
<span class="w">    </span><span class="kd">var</span><span class="w"> </span>name<span class="p">:</span><span class="n">String</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;asset___&quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">relativePath</span><span class="p">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">).</span><span class="n">join</span><span class="p">(</span><span class="s2">&quot;___&quot;</span><span class="p">).</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;-&quot;</span><span class="p">).</span><span class="n">join</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">).</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">).</span><span class="n">join</span><span class="p">(</span><span class="s2">&quot;__&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="n">relativePath</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;assets/&quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">relativePath</span><span class="p">;</span><span class="w"></span>

<span class="w">    </span><span class="n">fields</span><span class="p">.</span><span class="n">push</span><span class="p">({</span><span class="w"></span>
<span class="w">        </span><span class="n">name</span><span class="p">:</span><span class="w"> </span><span class="n">name</span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="n">doc</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;Relative path for file </span><span class="si">${</span><span class="n">file</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="n">access</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="n">Access</span><span class="p">.</span><span class="n">APublic</span><span class="p">,</span><span class="w"> </span><span class="n">Access</span><span class="p">.</span><span class="n">AStatic</span><span class="p">,</span><span class="w"> </span><span class="n">Access</span><span class="p">.</span><span class="n">AInline</span><span class="p">],</span><span class="w"></span>
<span class="w">        </span><span class="n">pos</span><span class="p">:</span><span class="w"> </span><span class="n">Context</span><span class="p">.</span><span class="n">currentPos</span><span class="p">(),</span><span class="w"></span>
<span class="w">        </span><span class="n">kind</span><span class="p">:</span><span class="w"> </span><span class="n">FieldType</span><span class="p">.</span><span class="n">FVar</span><span class="p">(</span><span class="k">macro</span><span class="p">:</span><span class="w"> </span><span class="n">String</span><span class="p">,</span><span class="w"> </span><span class="k">macro</span><span class="p">:</span><span class="w"> </span><span class="n">$v</span><span class="err">{relativePath}</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="p">});</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div> <p>Now we’re basically done, however I think the <code>kind</code> field deserves a bit more attention before we move on. The <code>kind</code> field is of type <a href="http://api.haxe.org/haxe/macro/FieldType.html"><code>FieldType</code></a>, which is an <code>enum</code> which can take the following types:</p> <ul> <li><code>FVar</code> (variable)</li> <li><code>FFun</code> (function)</li> <li><code>FProp</code> (property)</li> </ul> <p>Using Haxe’s <a href="https://haxe.org/manual/types-enum-instance.html"><code>enum instances</code></a>, each of these gets their own constructor:</p> <ul> <li><code>FVar(type:ComplexType, expression:Expr)</code></li> <li><code>FFun(function:Function)</code></li> <li><code>FProp(get:String, set:String, type:ComplexType, expression:Expr)</code></li> </ul> <p>In our case, we’re creating variables (we could create read-only properties, but I’ll leave that as an exercise to the reader), so create an <code>FVar</code>. We provide the type through <a href="https://haxe.org/manual/macro-reification-class.html">class reification</a> (we basically just say use the <code>String</code> class / type). We then provide the initialization expression using <a href="https://haxe.org/manual/macro-reification-expression.html">expression reification</a> (we just use the compile-time value of <code>relativePath</code>).</p> <p>So that’s that. To use our new superpowers, just reference the <code>AssetFiles</code> class:</p> <div class="highlight"><pre><span></span><span class="kd">var</span><span class="w"> </span>enemySprite<span class="p">:</span><span class="n">Sprite</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">loadSprite</span><span class="p">(</span><span class="n">AssetFiles</span><span class="p">.</span><span class="n">asset___sprites___enemy__png</span><span class="p">);</span><span class="w"></span>
<span class="c1">// equivalent to:</span><span class="w"></span>
<span class="kd">var</span><span class="w"> </span>enemySprite<span class="p">:</span><span class="n">Sprite</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">loadSprite</span><span class="p">(</span><span class="s2">&quot;assets/sprites/enemy.png&quot;</span><span class="p">);</span><span class="w"></span>
</pre></div> <h2><a href="#expression-macros" aria-hidden="true" class="anchor" id="headerexpression-macros"></a><a name="exprmacros"></a>Expression Macros</h2> <p>Expression macros are certainly the easiest type of macros to grasp, however that doesn’t mean they’re not worth much. Expression macros are just functions that get called by the compiler at compile time, with their output substituted into your code in place of the function call.</p> <p>In fact, there’s a decent chance you have used an expression macro from a library before without ever knowing it. Here is what calling our build date expression macro looks like:</p> <div class="highlight"><pre><span></span><span class="kd">var</span><span class="w"> </span>date<span class="p">:</span><span class="n">Date</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">MacroTools</span><span class="p">.</span><span class="n">dateBuilt</span><span class="p">();</span><span class="w"></span>
</pre></div> <p>Which is normal, everyday code. Except when you compile it, it is the same as writing:</p> <div class="highlight"><pre><span></span><span class="kd">var</span><span class="w"> </span>date<span class="p">:</span><span class="n">Date</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Date</span><span class="p">(</span><span class="mi">2016</span><span class="p">,</span><span class="w"> </span><span class="mi">10</span><span class="p">,</span><span class="w"> </span><span class="mi">12</span><span class="p">,</span><span class="w"> </span><span class="mi">21</span><span class="p">,</span><span class="w"> </span><span class="mi">05</span><span class="p">,</span><span class="w"> </span><span class="mi">47</span><span class="p">);</span><span class="w"></span>
</pre></div> <p>So let’s get down to writing our <code>dateBuilt</code> function:</p> <div class="highlight"><pre><span></span><span class="kn">package</span><span class="w"> </span><span class="nn">macros</span><span class="p">;</span><span class="w"></span>

<span class="kn">import</span><span class="w"> </span><span class="nn">haxe</span><span class="p">.</span><span class="nn">macro</span><span class="p">.</span><span class="nn">Expr</span><span class="p">;</span><span class="w"></span>
<span class="kn">import</span><span class="w"> </span><span class="nn">haxe</span><span class="p">.</span><span class="nn">macro</span><span class="p">.</span><span class="nn">Context</span><span class="p">;</span><span class="w"></span>

<span class="kd">class</span><span class="w"> </span><span class="n">MacroTools</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">macro</span><span class="w"> </span><span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nf">dateBuilt</span><span class="p">():</span><span class="n">ExprOf</span><span class="p">&lt;</span><span class="n">Date</span><span class="p">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="k">macro</span><span class="w"> </span><span class="n">Date</span><span class="p">.</span><span class="n">now</span><span class="p">();</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div> <p>Simple, right! There’s a few things going on:</p> <ol> <li>The function is prefixed by <code>macro</code>, which indicates its status as an expression macro</li> <li>The function returns a type called <code>ExprOf&lt;Date&gt;</code>. Expression macros must return <a href="http://api.haxe.org/haxe/macro/Expr.html">expressions</a> (which can easily be created through <a href="https://haxe.org/manual/macro-reification-expression.html">expression reification</a>). <code>ExprOf&lt;Date&gt;</code> just means an expression that is constrained to the <code>Date</code> type (we might as well help the type system as much as we can!).</li> <li>Since we need to return an expression, we use reification to convert our <code>Date.now()</code> call into an expression (using the <code>macro</code> keyword).</li> </ol> <p>There’s just one major problem with the above: instead of inserting the time that the project was compiled, we instead just insert the <code>Date.now()</code> expression, which will never align with our build time as it is a run-time call.</p> <p>Once compiled, it will look like this:</p> <div class="highlight"><pre><span></span><span class="kd">var</span><span class="w"> </span>date<span class="p">:</span><span class="n">Date</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Date</span><span class="p">.</span><span class="n">now</span><span class="p">();</span><span class="w"></span>
</pre></div> <p>instead of what we want:</p> <div class="highlight"><pre><span></span><span class="kd">var</span><span class="w"> </span>date<span class="p">:</span><span class="n">Date</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Date</span><span class="p">(</span><span class="mi">2016</span><span class="p">,</span><span class="w"> </span><span class="mi">10</span><span class="p">,</span><span class="w"> </span><span class="mi">12</span><span class="p">,</span><span class="w"> </span><span class="mi">21</span><span class="p">,</span><span class="w"> </span><span class="mi">05</span><span class="p">,</span><span class="w"> </span><span class="mi">47</span><span class="p">);</span><span class="w"></span>
</pre></div> <p>What we need to do is construct that last expression, so lets do that:</p> <div class="highlight"><pre><span></span><span class="k">macro</span><span class="w"> </span><span class="kd">private</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nf">dateBuilt</span><span class="p">():</span><span class="n">ExprOf</span><span class="p">&lt;</span><span class="n">Date</span><span class="p">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="c1">// get the date at compile time</span><span class="w"></span>
<span class="w">    </span><span class="kd">var</span><span class="w"> </span>date<span class="p">:</span><span class="n">Date</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Date</span><span class="p">.</span><span class="n">now</span><span class="p">();</span><span class="w"></span>

<span class="w">    </span><span class="c1">// use the values from the compile-time date to construct</span><span class="w"></span>
<span class="w">    </span><span class="c1">// a run-time expression</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="k">macro</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Date</span><span class="p">(</span><span class="w"></span>
<span class="w">        </span><span class="n">$v</span><span class="p">{</span><span class="n">date</span><span class="p">.</span><span class="n">getFullYear</span><span class="p">()},</span><span class="w"> </span><span class="n">$v</span><span class="p">{</span><span class="n">date</span><span class="p">.</span><span class="n">getMonth</span><span class="p">()},</span><span class="w"> </span><span class="n">$v</span><span class="p">{</span><span class="n">date</span><span class="p">.</span><span class="n">getDay</span><span class="p">()},</span><span class="w"></span>
<span class="w">        </span><span class="n">$v</span><span class="p">{</span><span class="n">date</span><span class="p">.</span><span class="n">getHours</span><span class="p">()},</span><span class="w"> </span><span class="n">$v</span><span class="p">{</span><span class="n">date</span><span class="p">.</span><span class="n">getMinutes</span><span class="p">()},</span><span class="w"> </span><span class="n">$v</span><span class="p">{</span><span class="n">date</span><span class="p">.</span><span class="n">getSeconds</span><span class="p">()}</span><span class="w"></span>
<span class="w">    </span><span class="p">);</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div> <p>Now when we run it, it will work as expected. We had to use the <code>$v{}</code> syntax to generate an expression from the <code>date.get_()</code> function calls. This is the shorthand equivalent of calling:</p> <div class="highlight"><pre><span></span><span class="n">$v</span><span class="p">{</span><span class="n">date</span><span class="p">.</span><span class="n">getFullYear</span><span class="p">()}</span><span class="w"></span>
<span class="c1">// is the same as:</span><span class="w"></span>
<span class="n">Context</span><span class="p">.</span><span class="n">makeExpr</span><span class="p">(</span><span class="n">date</span><span class="p">.</span><span class="n">getFullYear</span><span class="p">(),</span><span class="w"> </span><span class="n">Context</span><span class="p">.</span><span class="n">currentPos</span><span class="p">())</span><span class="w"></span>
</pre></div> <h2><a href="#conclusions" aria-hidden="true" class="anchor" id="headerconclusions"></a>Conclusions</h2> <p>Well, hopefully this rather long post helped introduce you to Haxe macros, or at least cleared things up a little bit. Please feel free to use any of the examples I’ve provided in your own code, and as always—don’t hesitate to ask if you have any questions!</p> <script src="/ruffle/ruffle.js"></script> </article> </main> <footer> <p> <span>© 2022 <a href="https://hamaluik.ca">Kenton Hamaluik</a></span> <span><a class="has-icon" href="https://blog.hamaluik.ca/feed.rss"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 256 256"><rect width="256" height="256" fill="none"></rect><path d="M48,144a64,64,0,0,1,64,64" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="16"></path><path d="M48,96A112,112,0,0,1,160,208" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="16"></path><path d="M48,48A160,160,0,0,1,208,208" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="16"></path><circle cx="52" cy="204" r="12"></circle></svg> Subscribe</a></span> </p> </footer> </body> </html>