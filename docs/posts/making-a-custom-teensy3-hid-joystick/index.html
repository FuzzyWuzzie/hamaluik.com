<!DOCTYPE html> <html lang="en-CA"> <head> <meta charset="utf-8"> <meta name="viewport" content="width=device-width, initial-scale=1"> <title>Making A Custom Teensy3 HID Joystick</title> <link rel="alternate" type="application/rss+xml" href="https://blog.hamaluik.ca/feed.rss" title="Posts RSS"> <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png"> <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png"> <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png"> <link rel="manifest" href="/site.webmanifest"> <link rel="mask-icon" href="/safari-pinned-tab.svg" color="#ff5555"> <meta name="msapplication-TileColor" content="#ff5555"> <meta name="theme-color" content="#ff5555"> <meta property="og:title" content="Making A Custom Teensy3 HID Joystick"/> <meta property="og:url" content="http://blog.hamaluik.ca/posts/making-a-custom-teensy3-hid-joystick/"/> <meta property="og:image" content="https://og-image.now.sh/Making%20A%20Custom%20Teensy3%20HID%20Joystick.png?theme=light&md=0&fontSize=75px&images=https%3A%2F%2Fassets.zeit.co%2Fimage%2Fupload%2Ffront%2Fassets%2Fdesign%2Fhyper-color-logo.svg&widths=350&heights=350"/> <meta property="og:description" content="I recently got married and for our wedding we decided we wanted to include some arcade games for a more unique, personal, and fun wedding experience. Me being the overly-ambitious type that I am decided it would be even more spectacular to create our own wedding arcade (&quot;Wedcade&quot; for short)! These actually turned out pretty decently in the end, and I&#x27;ll try to write up a post or two about them (as well as the arcade cabinets!) later, but for now I want to talk about using the Teensy3 as a joystick (namely using Teensyduino)."/> <meta property="og:type" content="article"/> <meta property="og:locale" content="en_CA"/> <meta property="og:site_name" content="Kenton Hamaluik"/> <meta property="article:published_time" content=" 2013-10-26T21:59:00+00:00 "/> <meta property="article:author" content="http://blog.hamaluik.ca/"/> <meta property="article:tag" content="C++"/> <meta name="twitter:card" content="summary_large_image"/> <meta name="twitter:image:alt" content="Making A Custom Teensy3 HID Joystick"/> <style> @font-face {font-family:"Crimson Pro";font-style:italic;font-weight:400;font-display:swap;src:local("Crimson Pro Italic"),local("CrimsonPro Italic"),local("Crimson-Pro-Italic"),local("CrimsonPro-Italic"),url(/fonts/crimson-pro-normal-latin-ext.woff2) format("woff2"),url(/fonts/CrimsonPro-Italic.ttf) format("ttf");unicode-range:U+0100-024F,U+0259,U+1E00-1EFF,U+2020,U+20A0-20AB,U+20AD-20CF,U+2113,U+2C60-2C7F,U+A720-A7FF;}@font-face {font-family:"Crimson Pro";font-style:italic;font-weight:400;font-display:swap;src:local("Crimson Pro Italic"),local("CrimsonPro Italic"),local("Crimson-Pro-Italic"),local("CrimsonPro-Italic"),url(/fonts/crimson-pro-italic-latin.woff2) format("woff2"),url(/fonts/CrimsonPro-Italic.ttf) format("ttf");unicode-range:U+0000-00FF,U+0131,U+0152-0153,U+02BB-02BC,U+02C6,U+02DA,U+02DC,U+2000-206F,U+2074,U+20AC,U+2122,U+2191,U+2193,U+2212,U+2215,U+FEFF,U+FFFD;}@font-face {font-family:"Crimson Pro";font-style:normal;font-weight:400;font-display:swap;src:local("Crimson Pro"),local("CrimsonPro"),local("Crimson-Pro"),local("CrimsonPro"),url(/fonts/crimson-pro-normal-latin-ext.woff2) format("woff2"),url(/fonts/CrimsonPro-Regular.ttf.ttf) format("ttf");unicode-range:U+0100-024F,U+0259,U+1E00-1EFF,U+2020,U+20A0-20AB,U+20AD-20CF,U+2113,U+2C60-2C7F,U+A720-A7FF;}@font-face {font-family:"Crimson Pro";font-style:normal;font-weight:400;font-display:swap;src:local("Crimson Pro"),local("CrimsonPro"),local("Crimson-Pro"),local("CrimsonPro"),url(/fonts/crimson-pro-normal-latin.woff2) format("woff2"),url(/fonts/CrimsonPro-Regular.ttf.ttf) format("ttf");unicode-range:U+0000-00FF,U+0131,U+0152-0153,U+02BB-02BC,U+02C6,U+02DA,U+02DC,U+2000-206F,U+2074,U+20AC,U+2122,U+2191,U+2193,U+2212,U+2215,U+FEFF,U+FFFD;}@font-face {font-family:"Crimson Pro";font-style:normal;font-weight:700;font-display:swap;src:local("Crimson Pro Bold"),local("CrimsonPro Bold"),local("Crimson-Pro-Bold"),local("CrimsonPro-Bold"),url(/fonts/crimson-pro-bold-latin-ext.woff2) format("woff2"),url(/fonts/CrimsonPro-Bold.ttf.ttf) format("ttf");unicode-range:U+0100-024F,U+0259,U+1E00-1EFF,U+2020,U+20A0-20AB,U+20AD-20CF,U+2113,U+2C60-2C7F,U+A720-A7FF;}@font-face {font-family:"Crimson Pro";font-style:normal;font-weight:700;font-display:swap;src:local("Crimson Pro Bold"),local("CrimsonPro Bold"),local("Crimson-Pro-Bold"),local("CrimsonPro-Bold"),url(/fonts/crimson-pro-bold-latin.woff2) format("woff2"),url(/fonts/CrimsonPro-Bold.ttf.ttf) format("ttf");unicode-range:U+0000-00FF,U+0131,U+0152-0153,U+02BB-02BC,U+02C6,U+02DA,U+02DC,U+2000-206F,U+2074,U+20AC,U+2122,U+2191,U+2193,U+2212,U+2215,U+FEFF,U+FFFD;}:root{--background-colour:#fafafa;--font-colour:#222;--footer-colour:#222;--link-colour:#076678;--visited-colour:#8f3f71;--theme-background:#282a36;--theme-currentline:#44475a;--theme-selection:#44475a;--theme-foreground:#f8f8f2;--theme-comment:#6272a4;--theme-cyan:#8be9fd;--theme-green:#50fa7b;--theme-orange:#ffb86c;--theme-pink:#ff79c6;--theme-purple:#bd93f9;--theme-red:#ff5555;--theme-yellow:#f1fa8c;}*{box-sizing:border-box;margin:0;}body{display:flex;flex-direction:column;min-height:100vh;padding:1rem clamp(1rem,5vw,3rem) 1rem;font-family:"Crimson Pro",Constantia,"Lucida Bright",Lucidabright,"Lucida Serif",Lucida,"DejaVu Serif","Bitstream Vera Serif","Liberation Serif",Georgia,serif;font-size:16pt;line-height:1.5;color:var(--font-colour);background:var(--background-colour);}body>*{--layout-spacing:max(2vh,2rem);width:100%;max-width:70ch;margin-left:auto;margin-right:auto;}main{margin-top:var(--layout-spacing);}footer{margin-top:auto;padding-top:var(--layout-spacing);}footer p{border-top:1px solid var(--footer-colour);padding-top:0.25em;font-size:0.9rem;color:var(--footer-colour);display:flex;justify-content:space-between;}:is(h1,h2,h3){line-height:1.2;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,sans-serif,BlinkMacSystemFont,Helvetica Neue;}:is(h2,h3,figure):not(:first-child){margin-top:2em;}article*+*{margin-top:1em;}a{word-break:break-all;color:var(--link-colour);text-underline-offset:0.15em;}a:visited{color:var(--visited-colour);}:not(pre)>code{word-break:break-all;font-family:"Source Code Pro","Fira Code","Fira Mono",Consolas,"Andale Mono WT","Andale Mono","Lucida Console","Lucida Sans Typewriter","DejaVu Sans Mono","Bitstream Vera Sans Mono","Liberation Mono","Nimbus Mono L",Monaco,"Courier New",Courier,monospace;font-size:12pt;}pre,figure{overflow-x:auto;}figure{display:flex;flex-direction:column;align-items:center;justify-content:center;max-width:100%;}figure>a>img,figure>img,figure>video{max-width:100%;margin:0 auto;}figure figcaption{font-size:0.8rem;text-align:center;}time{font-size:0.8rem;}header h1 a{color:var(--font-colour);font-size:4rem;font-weight:bold;word-break:normal;}header h1 a:visited{color:var(--font-colour);}svg{color:var(--font-colour);fill:currentColor;}img.white{mix-blend-mode:multiply;}.highlight{font-family:"Source Code Pro","Fira Code","Fira Mono",Consolas,"Andale Mono WT","Andale Mono","Lucida Console","Lucida Sans Typewriter","DejaVu Sans Mono","Bitstream Vera Sans Mono","Liberation Mono","Nimbus Mono L",Monaco,"Courier New",Courier,monospace;font-size:12pt;padding:0.25em;margin:1em 0;}.highlight .hll{background-color:#ffffcc;}.highlight{background:#282828;color:#ebdbb2;background-color:#282828;}.highlight .c{color:#928374;font-style:italic;background-color:#282828;}.highlight .err{color:#ebdbb2;background-color:#282828;}.highlight .esc{color:#ebdbb2;background-color:#282828;}.highlight .g{color:#ebdbb2;background-color:#282828;}.highlight .k{color:#fe8019;background-color:#282828;}.highlight .l{color:#ebdbb2;background-color:#282828;}.highlight .n{color:#ebdbb2;background-color:#282828;}.highlight .o{color:#fe8019;background-color:#282828;}.highlight .x{color:#ebdbb2;background-color:#282828;}.highlight .p{color:#ebdbb2;background-color:#282828;}.highlight .ch{color:#928374;font-style:italic;background-color:#282828;}.highlight .cm{color:#928374;font-style:italic;background-color:#282828;}.highlight .cp{color:#8ec07c;background-color:#282828;}.highlight .c1{color:#928374;font-style:italic;background-color:#282828;}.highlight .cs{color:#928374;font-style:italic;background-color:#282828;}.highlight .gd{color:#282828;background-color:#fb4934;}.highlight .ge{color:#83a598;text-decoration:underline;background-color:#282828;}.highlight .gr{color:#ebdbb2;font-weight:bold;background-color:#fb4934;}.highlight .gh{color:#b8bb26;font-weight:bold;background-color:#282828;}.highlight .gi{color:#282828;background-color:#b8bb26;}.highlight .go{color:#504945;background-color:#282828;}.highlight .gp{color:#ebdbb2;background-color:#282828;}.highlight .gs{color:#ebdbb2;background-color:#282828;}.highlight .gu{color:#b8bb26;font-weight:bold;background-color:#282828;}.highlight .gt{color:#ebdbb2;font-weight:bold;background-color:#fb4934;}.highlight .kc{color:#fe8019;background-color:#282828;}.highlight .kd{color:#fe8019;background-color:#282828;}.highlight .kn{color:#fe8019;background-color:#282828;}.highlight .kp{color:#fe8019;background-color:#282828;}.highlight .kr{color:#fe8019;background-color:#282828;}.highlight .kt{color:#fabd2f;background-color:#282828;}.highlight .ld{color:#ebdbb2;background-color:#282828;}.highlight .m{color:#d3869b;background-color:#282828;}.highlight .s{color:#b8bb26;background-color:#282828;}.highlight .na{color:#b8bb26;font-weight:bold;background-color:#282828;}.highlight .nb{color:#fabd2f;background-color:#282828;}.highlight .nc{color:#ebdbb2;background-color:#282828;}.highlight .no{color:#d3869b;background-color:#282828;}.highlight .nd{color:#ebdbb2;background-color:#282828;}.highlight .ni{color:#fabd2f;background-color:#282828;}.highlight .ne{color:#fb4934;background-color:#282828;}.highlight .nf{color:#fabd2f;background-color:#282828;}.highlight .nl{color:#fb4934;background-color:#282828;}.highlight .nn{color:#ebdbb2;background-color:#282828;}.highlight .nx{color:#ebdbb2;background-color:#282828;}.highlight .py{color:#ebdbb2;background-color:#282828;}.highlight .nt{color:#fb4934;background-color:#282828;}.highlight .nv{color:#ebdbb2;background-color:#282828;}.highlight .ow{color:#fe8019;background-color:#282828;}.highlight .w{color:#ebdbb2;background-color:#282828;}.highlight .mb{color:#d3869b;background-color:#282828;}.highlight .mf{color:#d3869b;background-color:#282828;}.highlight .mh{color:#d3869b;background-color:#282828;}.highlight .mi{color:#d3869b;background-color:#282828;}.highlight .mo{color:#d3869b;background-color:#282828;}.highlight .sb{color:#b8bb26;background-color:#282828;}.highlight .sc{color:#b8bb26;background-color:#282828;}.highlight .sd{color:#b8bb26;background-color:#282828;}.highlight .s2{color:#b8bb26;background-color:#282828;}.highlight .se{color:#b8bb26;background-color:#282828;}.highlight .sh{color:#b8bb26;background-color:#282828;}.highlight .si{color:#b8bb26;background-color:#282828;}.highlight .sx{color:#b8bb26;background-color:#282828;}.highlight .sr{color:#b8bb26;background-color:#282828;}.highlight .s1{color:#b8bb26;background-color:#282828;}.highlight .ss{color:#83a598;background-color:#282828;}.highlight .bp{color:#fabd2f;background-color:#282828;}.highlight .vc{color:#ebdbb2;background-color:#282828;}.highlight .vg{color:#ebdbb2;background-color:#282828;}.highlight .vi{color:#ebdbb2;background-color:#282828;}.highlight .il{color:#d3869b;background-color:#282828;}.slideshow{width:100%;}.slideshow .slides{display:grid;grid-auto-flow:column;grid-gap:1.5rem;overflow-x:auto;scroll-snap-type:x mandatory;padding:0 0 1.5rem;-webkit-overflow-scrolling:touch;}.slideshow .slides>*{width:min(45ch,60vw);height:auto;scroll-snap-align:center;scroll-snap-stop:always;}</style> </head> <body> <header> <h1><a href="https://blog.hamaluik.ca/">Kenton Hamaluik</a></h1> </header> <main> <article> <header> <h1> Making A Custom Teensy3 HID Joystick <time datetime='2013-10-26T21:59:00+00:00'>(2013-10-26)</time> </h1> </header> <p>I recently got married and for our wedding we decided we wanted to include some arcade games for a more unique, personal, and fun wedding experience. Me being the overly-ambitious type that I am decided it would be even more spectacular to create our <strong>own</strong> wedding arcade (“Wedcade” for short)! These actually turned out pretty decently in the end, and I’ll try to write up a post or two about them (as well as the arcade cabinets!) later, but for now I want to talk about using the Teensy3 as a joystick (namely using Teensyduino).</p> <p>Now, normally with the Teensy3, if you load up the joystick example, it will give you a generic joystick with 32 buttons, 6 axes, and 1 hat switch. This should be more than enough for anybody, and it was what I was planning on using. However, for whatever unknown reason, when I tried to use this joystick with <a href="http://unity3d.com/">Unity</a> (the game development suite I decided to use for the wedcade), Unity refused to acknowledge it and said the joystick was unsupported. This was a bit frustrating as it is really just a generic HID joystick, no drivers needed. I had my suspicions however that there were just simply too many buttons and / or axes or whatever for Unity to deal with, so it shut down the joystick altogether. With that in mind, I set out to make the Teensy enumerate as a generic joystick with only the axes and buttons that I needed it for!</p> <p>Everything I did here was for Teensyduino, so all files should be located in the Arduino/hardware/teensy/cores/teensy3 folder. Further, I am defining a new USB device / type called “arcade” which is two pairs of axes (one for each player) and a total of 16 buttons (though I’m not using all 16 in my current version of the arcade).</p> <p>I started off by editing <strong>usb_desc.h</strong>. This file is just a bunch of definitions that help set up the USB defitions in all the other files. After the <strong>USB_FLIGHTSIM</strong> definition area, I added a definition set which looks like:</p> <div class="highlight"><pre><span></span><span class="cp">#elif defined(USB_ARCADE)</span>
<span class="w">    </span><span class="cp">#define VENDOR_ID   0x16C0</span>
<span class="w">    </span><span class="cp">#define PRODUCT_ID    0x0489</span>
<span class="w">    </span><span class="cp">#define DEVICE_CLASS    0x03</span>
<span class="w">    </span><span class="cp">#define MANUFACTURER_NAME {&#39;B&#39;, &#39;l&#39;, &#39;a&#39;, &#39;z&#39;, &#39;i&#39;, &#39;n&#39;, &#39;g&#39;, &#39;M&#39;, &#39;a&#39;, &#39;m&#39;, &#39;m&#39;, &#39;o&#39;, &#39;t&#39;, &#39;h&#39;}</span>
<span class="w">    </span><span class="cp">#define MANUFACTURER_NAME_LEN 14</span>
<span class="w">    </span><span class="cp">#define PRODUCT_NAME    {&#39;W&#39;, &#39;e&#39;, &#39;d&#39;, &#39;c&#39;, &#39;a&#39;, &#39;d&#39;, &#39;e&#39;, &#39; &#39;, &#39;C&#39;, &#39;o&#39;, &#39;n&#39;, &#39;t&#39;, &#39;r&#39;, &#39;o&#39;, &#39;l&#39;, &#39;l&#39;, &#39;e&#39;, &#39;r&#39;}</span>
<span class="w">    </span><span class="cp">#define PRODUCT_NAME_LEN  18</span>
<span class="w">    </span><span class="cp">#define EP0_SIZE              64</span>
<span class="w">    </span><span class="cp">#define NUM_ENDPOINTS         2</span>
<span class="w">    </span><span class="cp">#define NUM_USB_BUFFERS       30</span>
<span class="w">    </span><span class="cp">#define NUM_INTERFACE         1</span>
<span class="w">    </span><span class="cp">#define ARCADE_INTERFACE      0 </span><span class="c1">// Joystick</span>
<span class="w">    </span><span class="cp">#define ARCADE_ENDPOINT       1</span>
<span class="w">    </span><span class="cp">#define ARCADE_SIZE           16</span>
<span class="w">    </span><span class="cp">#define ARCADE_INTERVAL       1</span>
<span class="w">    </span><span class="cp">#define ARCADE_DESC_OFFSET  (9)</span>
<span class="w">    </span><span class="cp">#define CONFIG_DESC_SIZE  (9 + 9+9+7)</span>
<span class="w">    </span><span class="cp">#define ENDPOINT1_CONFIG  ENDPOINT_TRANSIMIT_ONLY</span>
</pre></div> <ul> <li>In this section, if the <strong>USB_ARCADE</strong> definition is given, we set up all the included files to work as a “Wedcade Controller”. Specifically, I left the vendor ID to be the same as all the rest of the teensy devices, and created a new product id (0x0489).</li> <li>The class is defined as <strong>0x03</strong> (or, “<strong>Human Interface Device</strong>”).</li> <li>The manufacturer name and product name are pretty self-explanatory.</li> <li><strong>EP0_SIZE</strong> actually refers to the maximum packet size that the device will transmit. Note that I won’t be sending 64 byte packets, though I could. I believe this could easily be changed to what my actual packet size is, but it works like this so why mess with it?</li> <li>To understand the <strong>NUM_ENDPOINTS</strong> field, note that in USB communications each place that receives information counts as an “endpoint”. Also note that endpoint 0 is reserved and necessary, so if there is only one place receiving information (the computer in this case), there will be a total of 2 endpoints (the reserved one and the place my arcade controller is sending data). If I somehow had a force-feedback controller, there would be 3 endpoints (the third would be for the controller to read force-feedback data from the computer). I think.</li> <li><strong>NUM_USB_BUFFERS</strong> is the number of packets to buffer. 30 was just the default for the USB_SERIAL_HID section so I figured it would be ok here. It could probably be less as there is a lot less data transmission in my case.</li> <li><strong>NUM_INTERFACE</strong> defines how many virtual things this usb device will represent. In my case, there is just the single controller, so this is 1.</li> <li>With only 1 interface, <strong>ARCADE_INTERFACE</strong> is the first one (0)</li> <li>The arcade controller also connects to the first available endpoint (<strong>ARCADE_ENDPOINT</strong> 1) (0 is reserved, remember?)</li> <li>Since my device only sends information, I configured the endpoint to be transmit only</li> <li>The remaining parameters all relate to sizes of the data fields that describe the USB device. Nothing to do here but count bytes in the <em>usb_desc.c</em> file.</li> </ul> <p>With <strong>usb_desc.h</strong> in place, I added the following to the usb_desc.c file (right below the <strong>#ifdef JOYSTICK_INTERFACE … #endif</strong> section:</p> <div class="highlight"><pre><span></span><span class="cp">#ifdef ARCADE_INTERFACE</span>
<span class="k">static</span><span class="w"> </span><span class="kt">uint8_t</span><span class="w"> </span><span class="n">arcade_report_desc</span><span class="p">[]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="mh">0x05</span><span class="p">,</span><span class="w"> </span><span class="mh">0x01</span><span class="p">,</span><span class="w">                    </span><span class="c1">// USAGE_PAGE (Generic Desktop)</span>
<span class="w">    </span><span class="mh">0x09</span><span class="p">,</span><span class="w"> </span><span class="mh">0x04</span><span class="p">,</span><span class="w">                    </span><span class="c1">// USAGE (Joystick)</span>
<span class="w">    </span><span class="mh">0xa1</span><span class="p">,</span><span class="w"> </span><span class="mh">0x01</span><span class="p">,</span><span class="w">                    </span><span class="c1">// COLLECTION (Application)</span>
<span class="w">    </span><span class="mh">0x09</span><span class="p">,</span><span class="w"> </span><span class="mh">0x04</span><span class="p">,</span><span class="w">                    </span><span class="c1">//   USAGE (Joystick)</span>
<span class="w">    </span><span class="mh">0xa1</span><span class="p">,</span><span class="w"> </span><span class="mh">0x00</span><span class="p">,</span><span class="w">                    </span><span class="c1">//   COLLECTION (Physical)</span>
<span class="w">    </span><span class="mh">0x09</span><span class="p">,</span><span class="w"> </span><span class="mh">0x30</span><span class="p">,</span><span class="w">                    </span><span class="c1">//     USAGE (X)</span>
<span class="w">    </span><span class="mh">0x09</span><span class="p">,</span><span class="w"> </span><span class="mh">0x31</span><span class="p">,</span><span class="w">                    </span><span class="c1">//     USAGE (Y)</span>
<span class="w">    </span><span class="mh">0x09</span><span class="p">,</span><span class="w"> </span><span class="mh">0x33</span><span class="p">,</span><span class="w">                    </span><span class="c1">//     USAGE (Rx)</span>
<span class="w">    </span><span class="mh">0x09</span><span class="p">,</span><span class="w"> </span><span class="mh">0x34</span><span class="p">,</span><span class="w">                    </span><span class="c1">//     USAGE (Ry)</span>
<span class="w">    </span><span class="mh">0x75</span><span class="p">,</span><span class="w"> </span><span class="mh">0x08</span><span class="p">,</span><span class="w">                    </span><span class="c1">//     REPORT_SIZE (8)</span>
<span class="w">    </span><span class="mh">0x95</span><span class="p">,</span><span class="w"> </span><span class="mh">0x04</span><span class="p">,</span><span class="w">                    </span><span class="c1">//     REPORT_COUNT (4)</span>
<span class="w">    </span><span class="mh">0x45</span><span class="p">,</span><span class="w"> </span><span class="mh">0x7f</span><span class="p">,</span><span class="w">                    </span><span class="c1">//     PHYSICAL_MAXIMUM (127)</span>
<span class="w">    </span><span class="mh">0x35</span><span class="p">,</span><span class="w"> </span><span class="mh">0x81</span><span class="p">,</span><span class="w">                    </span><span class="c1">//     PHYSICAL_MINIMUM (-127)</span>
<span class="w">    </span><span class="mh">0x81</span><span class="p">,</span><span class="w"> </span><span class="mh">0x02</span><span class="p">,</span><span class="w">                    </span><span class="c1">//     INPUT (Data,Var,Abs)</span>
<span class="w">    </span><span class="mh">0x05</span><span class="p">,</span><span class="w"> </span><span class="mh">0x09</span><span class="p">,</span><span class="w">                    </span><span class="c1">//     USAGE_PAGE (Button)</span>
<span class="w">    </span><span class="mh">0x19</span><span class="p">,</span><span class="w"> </span><span class="mh">0x01</span><span class="p">,</span><span class="w">                    </span><span class="c1">//     USAGE_MINIMUM (Button 1)</span>
<span class="w">    </span><span class="mh">0x29</span><span class="p">,</span><span class="w"> </span><span class="mh">0x10</span><span class="p">,</span><span class="w">                    </span><span class="c1">//     USAGE_MAXIMUM (Button 16)</span>
<span class="w">    </span><span class="mh">0x15</span><span class="p">,</span><span class="w"> </span><span class="mh">0x00</span><span class="p">,</span><span class="w">                    </span><span class="c1">//     LOGICAL_MINIMUM (0)</span>
<span class="w">    </span><span class="mh">0x25</span><span class="p">,</span><span class="w"> </span><span class="mh">0x01</span><span class="p">,</span><span class="w">                    </span><span class="c1">//     LOGICAL_MAXIMUM (1)</span>
<span class="w">    </span><span class="mh">0x75</span><span class="p">,</span><span class="w"> </span><span class="mh">0x01</span><span class="p">,</span><span class="w">                    </span><span class="c1">//     REPORT_SIZE (1)</span>
<span class="w">    </span><span class="mh">0x95</span><span class="p">,</span><span class="w"> </span><span class="mh">0x10</span><span class="p">,</span><span class="w">                    </span><span class="c1">//     REPORT_COUNT (16)</span>
<span class="w">    </span><span class="mh">0x81</span><span class="p">,</span><span class="w"> </span><span class="mh">0x02</span><span class="p">,</span><span class="w">                    </span><span class="c1">//     INPUT (Data,Var,Abs)</span>
<span class="w">    </span><span class="mh">0xc0</span><span class="p">,</span><span class="w">                        </span><span class="c1">//   END_COLLECTION</span>
<span class="w">    </span><span class="mh">0xc0</span><span class="w">                        </span><span class="c1">// END_COLLECTION</span>
<span class="p">};</span><span class="w"></span>
<span class="cp">#endif</span>
</pre></div> <p>This is the actual USB descriptor and was created using the somewhat clunky [USB Descriptor Tool](<a href="http://www.usb.org/developers/hidpage#HID">http://www.usb.org/developers/hidpage#HID</a> Descriptor Tool). It defines that we have a joystick device with 4 physical axes and 16 physical buttons. Each of the 4 axes will report a single byte with a value between -127 and 127 and each button will report a value of 0 or 1. All 16 buttons will be combined into 2 bytes of data so they’re all packed together (for a total packet size of 6 bytes). For more information on how to create something like this you can try <a href="http://www.frank-zhao.com/cache/hid_tutorial_1.php">http://www.frank-zhao.com/cache/hid_tutorial_1.php</a> and/or the pdf at <a href="http://www.picbasic.co.uk/forum/showthread.php?t=11950">http://www.picbasic.co.uk/forum/showthread.php?t=11950</a>. It took me a little bit to get this right, so I wish you the best of luck if you want to deviate substantially from this!</p> <p>With the descriptor written, add the following to the <strong>usb_desc.c</strong> file (right below the line “<strong>#endif // JOYSTICK_INTERFACE</strong>”):</p> <div class="highlight"><pre><span></span><span class="cp">#ifdef ARCADE_INTERFACE</span>
<span class="w">        </span><span class="c1">// interface descriptor, USB spec 9.6.5, page 267-269, Table 9-12</span>
<span class="w">        </span><span class="mi">9</span><span class="p">,</span><span class="w">                                      </span><span class="c1">// bLength</span>
<span class="w">        </span><span class="mi">4</span><span class="p">,</span><span class="w">                                      </span><span class="c1">// bDescriptorType</span>
<span class="w">        </span><span class="n">ARCADE_INTERFACE</span><span class="p">,</span><span class="w">                     </span><span class="c1">// bInterfaceNumber</span>
<span class="w">        </span><span class="mi">0</span><span class="p">,</span><span class="w">                                      </span><span class="c1">// bAlternateSetting</span>
<span class="w">        </span><span class="mi">1</span><span class="p">,</span><span class="w">                                      </span><span class="c1">// bNumEndpoints</span>
<span class="w">        </span><span class="mh">0x03</span><span class="p">,</span><span class="w">                                   </span><span class="c1">// bInterfaceClass (0x03 = HID)</span>
<span class="w">        </span><span class="mh">0x00</span><span class="p">,</span><span class="w">                                   </span><span class="c1">// bInterfaceSubClass</span>
<span class="w">        </span><span class="mh">0x00</span><span class="p">,</span><span class="w">                                   </span><span class="c1">// bInterfaceProtocol</span>
<span class="w">        </span><span class="mi">0</span><span class="p">,</span><span class="w">                                      </span><span class="c1">// iInterface</span>
<span class="w">        </span><span class="c1">// HID interface descriptor, HID 1.11 spec, section 6.2.1</span>
<span class="w">        </span><span class="mi">9</span><span class="p">,</span><span class="w">                                      </span><span class="c1">// bLength</span>
<span class="w">        </span><span class="mh">0x21</span><span class="p">,</span><span class="w">                                   </span><span class="c1">// bDescriptorType</span>
<span class="w">        </span><span class="mh">0x11</span><span class="p">,</span><span class="w"> </span><span class="mh">0x01</span><span class="p">,</span><span class="w">                             </span><span class="c1">// bcdHID</span>
<span class="w">        </span><span class="mi">0</span><span class="p">,</span><span class="w">                                      </span><span class="c1">// bCountryCode</span>
<span class="w">        </span><span class="mi">1</span><span class="p">,</span><span class="w">                                      </span><span class="c1">// bNumDescriptors</span>
<span class="w">        </span><span class="mh">0x22</span><span class="p">,</span><span class="w">                                   </span><span class="c1">// bDescriptorType</span>
<span class="w">        </span><span class="n">LSB</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">arcade_report_desc</span><span class="p">)),</span><span class="w">        </span><span class="c1">// wDescriptorLength</span>
<span class="w">        </span><span class="n">MSB</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">arcade_report_desc</span><span class="p">)),</span><span class="w"></span>
<span class="w">        </span><span class="c1">// endpoint descriptor, USB spec 9.6.6, page 269-271, Table 9-13</span>
<span class="w">        </span><span class="mi">7</span><span class="p">,</span><span class="w">                                      </span><span class="c1">// bLength</span>
<span class="w">        </span><span class="mi">5</span><span class="p">,</span><span class="w">                                      </span><span class="c1">// bDescriptorType</span>
<span class="w">        </span><span class="n">ARCADE_ENDPOINT</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="mh">0x80</span><span class="p">,</span><span class="w">               </span><span class="c1">// bEndpointAddress</span>
<span class="w">        </span><span class="mh">0x03</span><span class="p">,</span><span class="w">                                   </span><span class="c1">// bmAttributes (0x03=intr)</span>
<span class="w">        </span><span class="n">ARCADE_SIZE</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w">                       </span><span class="c1">// wMaxPacketSize</span>
<span class="w">        </span><span class="n">ARCADE_INTERVAL</span><span class="p">,</span><span class="w">                      </span><span class="c1">// bInterval</span>
<span class="cp">#endif </span><span class="c1">// ARCADE_INTERFACE</span>
</pre></div> <p>This is another section that defines the usb interface we’re using. It’s pretty much copy-pasted from the JOYSTICK_INTERFACE section, with name changes to reference the arcade aspect of it.</p> <p>Finally, near the bottom of the file, add (just below the <strong>#ifdef JOYSTICK_INTERACE … #endif</strong> section):</p> <div class="highlight"><pre><span></span><span class="cp">#ifdef ARCADE_INTERFACE</span>
<span class="w">        </span><span class="p">{</span><span class="mh">0x2200</span><span class="p">,</span><span class="w"> </span><span class="n">ARCADE_INTERFACE</span><span class="p">,</span><span class="w"> </span><span class="n">arcade_report_desc</span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">arcade_report_desc</span><span class="p">)},</span><span class="w"></span>
<span class="w">        </span><span class="p">{</span><span class="mh">0x2100</span><span class="p">,</span><span class="w"> </span><span class="n">ARCADE_INTERFACE</span><span class="p">,</span><span class="w"> </span><span class="n">config_descriptor</span><span class="o">+</span><span class="n">ARCADE_DESC_OFFSET</span><span class="p">,</span><span class="w"> </span><span class="mi">9</span><span class="p">},</span><span class="w"></span>
<span class="cp">#endif</span>
</pre></div> <p>This just actually includes the descriptor in the list and should be all we need to do to set up the USB descriptors. Now we just need to write a class to actually use our joystick with. I’ll post my code here, but it is more or less a direct copy-paste and slight strip-down of the usb_joystick.h / usb_joystick.c files found in the directory:</p> <div class="highlight"><pre><span></span><span class="c1">// usb_arcade.h</span>
<span class="cp">#ifndef _USB_ARCADE_H_</span>
<span class="cp">#define _USB_ARCADE_H_</span>

<span class="cp">#if defined(USB_ARCADE)</span>

<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;inttypes.h&gt;</span><span class="cp"></span>

<span class="c1">// C language implementation</span>
<span class="cp">#ifdef __cplusplus</span>
<span class="k">extern</span><span class="w"> </span><span class="s">&quot;C&quot;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="cp">#endif</span>
<span class="kt">int</span><span class="w"> </span><span class="nf">usb_arcade_send</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span><span class="w"></span>
<span class="c1">// we have packets that are 6 bytes long</span>
<span class="k">extern</span><span class="w"> </span><span class="kt">uint8_t</span><span class="w"> </span><span class="n">usb_arcade_data</span><span class="p">[</span><span class="mi">6</span><span class="p">];</span><span class="w"></span>
<span class="cp">#ifdef __cplusplus</span>
<span class="p">}</span><span class="w"></span>
<span class="cp">#endif</span>

<span class="c1">// C++ interface</span>
<span class="cp">#ifdef __cplusplus</span>
<span class="k">class</span><span class="w"> </span><span class="nc">usb_arcade_class</span><span class="w"></span>
<span class="p">{</span><span class="w"></span>
<span class="k">private</span><span class="o">:</span><span class="w"></span>
<span class="w">    </span><span class="k">static</span><span class="w"> </span><span class="kt">uint8_t</span><span class="w"> </span><span class="n">auto_send</span><span class="p">;</span><span class="w"></span>

<span class="k">public</span><span class="o">:</span><span class="w"></span>
<span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="n">button</span><span class="p">(</span><span class="kt">uint8_t</span><span class="w"> </span><span class="n">button</span><span class="p">,</span><span class="w"> </span><span class="kt">bool</span><span class="w"> </span><span class="n">val</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">--</span><span class="n">button</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mi">16</span><span class="p">)</span><span class="w"> </span><span class="k">return</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">val</span><span class="p">)</span><span class="w"> </span><span class="n">usb_arcade_data</span><span class="p">[</span><span class="n">button</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mi">8</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="mi">5</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="mi">4</span><span class="p">]</span><span class="w"> </span><span class="o">|=</span><span class="w"> </span><span class="p">(</span><span class="mi">1</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="p">(</span><span class="n">button</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mi">8</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="p">(</span><span class="n">button</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">8</span><span class="p">)</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">button</span><span class="p">));</span><span class="w"></span>
<span class="w">        </span><span class="k">else</span><span class="w"> </span><span class="n">usb_arcade_data</span><span class="p">[</span><span class="n">button</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mi">8</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="mi">5</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="mi">4</span><span class="p">]</span><span class="w"> </span><span class="o">&amp;=</span><span class="w"> </span><span class="o">~</span><span class="p">(</span><span class="mi">1</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="p">(</span><span class="n">button</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mi">8</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="p">(</span><span class="n">button</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">8</span><span class="p">)</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">button</span><span class="p">));</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="p">(</span><span class="n">auto_send</span><span class="p">)</span><span class="w"> </span><span class="n">usb_arcade_send</span><span class="p">();</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="n">axis</span><span class="p">(</span><span class="kt">uint8_t</span><span class="w"> </span><span class="n">axis</span><span class="p">,</span><span class="w"> </span><span class="kt">int8_t</span><span class="w"> </span><span class="n">val</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="p">(</span><span class="n">axis</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mi">4</span><span class="p">)</span><span class="w"> </span><span class="k">return</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="p">(</span><span class="n">val</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="n">usb_arcade_data</span><span class="p">[</span><span class="n">axis</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">127</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="p">(</span><span class="n">val</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="n">usb_arcade_data</span><span class="p">[</span><span class="n">axis</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">-127</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="k">else</span><span class="w"> </span><span class="n">usb_arcade_data</span><span class="p">[</span><span class="n">axis</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="p">(</span><span class="n">auto_send</span><span class="p">)</span><span class="w"> </span><span class="n">usb_arcade_send</span><span class="p">();</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="n">setAutoSend</span><span class="p">(</span><span class="kt">bool</span><span class="w"> </span><span class="n">send</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">auto_send</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">send</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="n">send</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">usb_arcade_send</span><span class="p">();</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="p">};</span><span class="w"></span>
<span class="k">extern</span><span class="w"> </span><span class="n">usb_arcade_class</span><span class="w"> </span><span class="n">Arcade</span><span class="p">;</span><span class="w"></span>

<span class="cp">#endif </span><span class="c1">// __cplusplus</span>
<span class="cp">#endif </span><span class="c1">// USB_ARCADE</span>
<span class="cp">#endif </span><span class="c1">// _USB_ARCADE_H_</span>
</pre></div> <div class="highlight"><pre><span></span><span class="c1">// usb_arcade.c</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;usb_dev.h&quot;</span><span class="cp"></span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;usb_arcade.h&quot;</span><span class="cp"></span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;core_pins.h&quot;</span><span class="c1"> // for yield()</span><span class="cp"></span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;HardwareSerial.h&quot;</span><span class="cp"></span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;string.h&gt;</span><span class="c1"> // for memcpy()</span><span class="cp"></span>

<span class="cp">#ifdef USB_ARCADE </span><span class="c1">// defined by usb_dev.h -&gt; usb_desc.h</span>

<span class="kt">uint8_t</span><span class="w"> </span><span class="n">usb_arcade_data</span><span class="p">[</span><span class="mi">6</span><span class="p">];</span><span class="w"></span>

<span class="c1">// Maximum number of transmit packets to queue so we don&#39;t starve other endpoints for memory</span>
<span class="cp">#define TX_PACKET_LIMIT 3</span>

<span class="k">static</span><span class="w"> </span><span class="kt">uint8_t</span><span class="w"> </span><span class="n">transmit_previous_timeout</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="w"></span>

<span class="c1">// When the PC isn&#39;t listening, how long do we wait before discarding data?</span>
<span class="cp">#define TX_TIMEOUT_MSEC 30</span>

<span class="cp">#if F_CPU == 96000000</span>
<span class="w">  </span><span class="cp">#define TX_TIMEOUT (TX_TIMEOUT_MSEC * 596)</span>
<span class="cp">#elif F_CPU == 48000000</span>
<span class="w">  </span><span class="cp">#define TX_TIMEOUT (TX_TIMEOUT_MSEC * 428)</span>
<span class="cp">#elif F_CPU == 24000000</span>
<span class="w">  </span><span class="cp">#define TX_TIMEOUT (TX_TIMEOUT_MSEC * 262)</span>
<span class="cp">#endif</span>

<span class="kt">int</span><span class="w"> </span><span class="nf">usb_arcade_send</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="w"></span>
<span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">wait_count</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="n">usb_packet_t</span><span class="w"> </span><span class="o">*</span><span class="n">tx_packet</span><span class="p">;</span><span class="w"></span>

<span class="w">    </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">usb_configuration</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="mi">-1</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">usb_tx_packet_count</span><span class="p">(</span><span class="n">ARCADE_ENDPOINT</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">TX_PACKET_LIMIT</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">            </span><span class="n">tx_packet</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">usb_malloc</span><span class="p">();</span><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">tx_packet</span><span class="p">)</span><span class="w"> </span><span class="k">break</span><span class="p">;</span><span class="w">        </span><span class="p">}</span><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">++</span><span class="n">wait_count</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">TX_TIMEOUT</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">transmit_previous_timeout</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                                                                         </span><span class="n">transmit_previous_timeout</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w"></span>
<span class="w">                                                                         </span><span class="k">return</span><span class="w"> </span><span class="mi">-1</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">        </span><span class="n">yield</span><span class="p">();</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="n">transmit_previous_timeout</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="n">memcpy</span><span class="p">(</span><span class="n">tx_packet</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">,</span><span class="w"> </span><span class="n">usb_arcade_data</span><span class="p">,</span><span class="w"> </span><span class="mi">6</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="n">tx_packet</span><span class="o">-&gt;</span><span class="n">len</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">6</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="n">usb_tx</span><span class="p">(</span><span class="n">ARCADE_ENDPOINT</span><span class="p">,</span><span class="w"> </span><span class="n">tx_packet</span><span class="p">);</span><span class="w"></span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="cp">#endif </span><span class="c1">// USB_ARCADE</span>
</pre></div> <p>All this code does is provide an interface for defining usb packets to be sent to the computer and gives us the functions Arcade.button(button, val) and Arcade.axis(axis, val) to use instead of manually writing the packets and sending them ourselves. In order to make these classes accessible in the Arduino environment, add the following to the <strong>usb_inst.cpp</strong> file:</p> <div class="highlight"><pre><span></span><span class="cp">#ifdef USB_ARCADE</span>
<span class="n">usb_arcade_class</span><span class="w"> </span><span class="n">Arcade</span><span class="p">;</span><span class="w"></span>
<span class="kt">uint8_t</span><span class="w"> </span><span class="n">usb_arcade_class</span><span class="o">::</span><span class="n">auto_send</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"></span>
<span class="cp">#endif</span>
</pre></div> <p>And the following to <strong>WProgram.h</strong>:</p> <div class="highlight"><pre><span></span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;usb_arcade.h&quot;</span><span class="cp"></span>
</pre></div> <p>Finally, in order to actually make the Arduino environment use the new arcade descriptors, add the following lines to the file <em>Arduino/hardware/teensy/boards.txt</em> (after the teensy3.menu.usb.flightsim entries):</p> <div class="highlight"><pre><span></span><span class="n">teensy3</span><span class="p">.</span><span class="n">menu</span><span class="p">.</span><span class="n">usb</span><span class="p">.</span><span class="n">arcade</span><span class="p">.</span><span class="n">name</span><span class="o">=</span><span class="n">Wedcade</span><span class="w"> </span><span class="n">Controller</span><span class="w"></span>
<span class="n">teensy3</span><span class="p">.</span><span class="n">menu</span><span class="p">.</span><span class="n">usb</span><span class="p">.</span><span class="n">arcade</span><span class="p">.</span><span class="n">build</span><span class="p">.</span><span class="n">define0</span><span class="o">=-</span><span class="n">DUSB_ARCADE</span><span class="w"></span>
<span class="n">teensy3</span><span class="p">.</span><span class="n">menu</span><span class="p">.</span><span class="n">usb</span><span class="p">.</span><span class="n">arcade</span><span class="p">.</span><span class="n">fake_serial</span><span class="o">=</span><span class="n">teensy_gateway</span><span class="w"></span>
</pre></div> <p>And that’s pretty much it! I included the sketch I used so you can see how it works, but basically I have my buttons connected to a bunch of pins. I then poll these at 50 Hz and send an update packet to the computer at each iteration. I ended up not using the axes at all because although they worked in Windows, they did not work properly in Unity. Instead I just mapped each of the up / right / down / left directions to a button on the controller and used the buttons for directional input instead of the axes.</p> <div class="highlight"><pre><span></span><span class="k">const</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">ledPin</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">13</span><span class="p">;</span><span class="w"></span>

<span class="c1">// joystick colour mappings</span>
<span class="c1">// g  l</span>
<span class="c1">// y  r</span>
<span class="c1">// o  d</span>
<span class="c1">// r  u</span>

<span class="c1">// player 1 bank</span>
<span class="k">const</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">P1_A</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">2</span><span class="p">;</span><span class="w"></span>
<span class="k">const</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">P1_B</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">3</span><span class="p">;</span><span class="w"></span>
<span class="k">const</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">P1_LEFT</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">4</span><span class="p">;</span><span class="w"></span>
<span class="k">const</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">P1_RIGHT</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">5</span><span class="p">;</span><span class="w"></span>
<span class="k">const</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">P1_DOWN</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">6</span><span class="p">;</span><span class="w"></span>
<span class="k">const</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">P1_UP</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">7</span><span class="p">;</span><span class="w"></span>

<span class="k">const</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">START_BUTTON</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">8</span><span class="p">;</span><span class="w"></span>

<span class="c1">// player 2 bank</span>
<span class="k">const</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">P2_UP</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">15</span><span class="p">;</span><span class="w"></span>
<span class="k">const</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">P2_DOWN</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">14</span><span class="p">;</span><span class="w"></span>
<span class="k">const</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">P2_RIGHT</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">17</span><span class="p">;</span><span class="w"></span>
<span class="k">const</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">P2_LEFT</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">16</span><span class="p">;</span><span class="w"></span>
<span class="k">const</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">P2_B</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">18</span><span class="p">;</span><span class="w"></span>
<span class="k">const</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">P2_A</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">19</span><span class="p">;</span><span class="w"></span>

<span class="n">boolean</span><span class="w"> </span><span class="n">ledOn</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span><span class="w"></span>
<span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">lastTime</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"></span>

<span class="kt">void</span><span class="w"> </span><span class="nf">setup</span><span class="p">()</span><span class="w"></span>
<span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">pinMode</span><span class="p">(</span><span class="n">ledPin</span><span class="p">,</span><span class="w"> </span><span class="n">OUTPUT</span><span class="p">);</span><span class="w"></span>

<span class="w">    </span><span class="n">pinMode</span><span class="p">(</span><span class="n">P1_A</span><span class="p">,</span><span class="w"> </span><span class="n">INPUT_PULLUP</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="n">pinMode</span><span class="p">(</span><span class="n">P1_B</span><span class="p">,</span><span class="w"> </span><span class="n">INPUT_PULLUP</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="n">pinMode</span><span class="p">(</span><span class="n">P1_LEFT</span><span class="p">,</span><span class="w"> </span><span class="n">INPUT_PULLUP</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="n">pinMode</span><span class="p">(</span><span class="n">P1_RIGHT</span><span class="p">,</span><span class="w"> </span><span class="n">INPUT_PULLUP</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="n">pinMode</span><span class="p">(</span><span class="n">P1_DOWN</span><span class="p">,</span><span class="w"> </span><span class="n">INPUT_PULLUP</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="n">pinMode</span><span class="p">(</span><span class="n">P1_UP</span><span class="p">,</span><span class="w"> </span><span class="n">INPUT_PULLUP</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="n">pinMode</span><span class="p">(</span><span class="n">START_BUTTON</span><span class="p">,</span><span class="w"> </span><span class="n">INPUT_PULLUP</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="n">pinMode</span><span class="p">(</span><span class="n">P2_A</span><span class="p">,</span><span class="w"> </span><span class="n">INPUT_PULLUP</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="n">pinMode</span><span class="p">(</span><span class="n">P2_B</span><span class="p">,</span><span class="w"> </span><span class="n">INPUT_PULLUP</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="n">pinMode</span><span class="p">(</span><span class="n">P2_LEFT</span><span class="p">,</span><span class="w"> </span><span class="n">INPUT_PULLUP</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="n">pinMode</span><span class="p">(</span><span class="n">P2_RIGHT</span><span class="p">,</span><span class="w"> </span><span class="n">INPUT_PULLUP</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="n">pinMode</span><span class="p">(</span><span class="n">P2_DOWN</span><span class="p">,</span><span class="w"> </span><span class="n">INPUT_PULLUP</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="n">pinMode</span><span class="p">(</span><span class="n">P2_UP</span><span class="p">,</span><span class="w"> </span><span class="n">INPUT_PULLUP</span><span class="p">);</span><span class="w"></span>

<span class="w">    </span><span class="c1">// read the entire joystick at once instead of per event</span>
<span class="w">    </span><span class="n">Arcade</span><span class="p">.</span><span class="n">setAutoSend</span><span class="p">(</span><span class="nb">false</span><span class="p">);</span><span class="w"></span>

<span class="w">    </span><span class="n">lastTime</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">millis</span><span class="p">();</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="kt">void</span><span class="w"> </span><span class="nf">loop</span><span class="p">()</span><span class="w"></span>
<span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">time</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">millis</span><span class="p">();</span><span class="w"></span>
<span class="w">    </span><span class="c1">// run at 50 Hz</span>
<span class="w">    </span><span class="k">if</span><span class="p">(</span><span class="n">time</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">lastTime</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mi">20</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">lastTime</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">time</span><span class="p">;</span><span class="w"></span>

<span class="w">        </span><span class="c1">// read the data of all our buttons</span>
<span class="w">        </span><span class="c1">// our buttons</span>
<span class="w">        </span><span class="n">Arcade</span><span class="p">.</span><span class="n">button</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">digitalRead</span><span class="p">(</span><span class="n">P1_A</span><span class="p">));</span><span class="w"></span>
<span class="w">        </span><span class="n">Arcade</span><span class="p">.</span><span class="n">button</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">digitalRead</span><span class="p">(</span><span class="n">P1_B</span><span class="p">));</span><span class="w"></span>
<span class="w">        </span><span class="n">Arcade</span><span class="p">.</span><span class="n">button</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">digitalRead</span><span class="p">(</span><span class="n">P2_A</span><span class="p">));</span><span class="w"></span>
<span class="w">        </span><span class="n">Arcade</span><span class="p">.</span><span class="n">button</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">digitalRead</span><span class="p">(</span><span class="n">P2_B</span><span class="p">));</span><span class="w"></span>

<span class="w">        </span><span class="n">Arcade</span><span class="p">.</span><span class="n">button</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">digitalRead</span><span class="p">(</span><span class="n">START_BUTTON</span><span class="p">));</span><span class="w"></span>

<span class="w">        </span><span class="c1">// now our axes</span>
<span class="w">        </span><span class="n">Arcade</span><span class="p">.</span><span class="n">axis</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">digitalRead</span><span class="p">(</span><span class="n">P1_LEFT</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="mi">-1</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="p">(</span><span class="n">digitalRead</span><span class="p">(</span><span class="n">P1_RIGHT</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="mi">0</span><span class="p">));</span><span class="w"></span>
<span class="w">        </span><span class="n">Arcade</span><span class="p">.</span><span class="n">axis</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">digitalRead</span><span class="p">(</span><span class="n">P1_UP</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="mi">-1</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="p">(</span><span class="n">digitalRead</span><span class="p">(</span><span class="n">P1_DOWN</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="mi">0</span><span class="p">));</span><span class="w"></span>
<span class="w">        </span><span class="n">Arcade</span><span class="p">.</span><span class="n">axis</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="n">digitalRead</span><span class="p">(</span><span class="n">P2_LEFT</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="mi">-1</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="p">(</span><span class="n">digitalRead</span><span class="p">(</span><span class="n">P2_RIGHT</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="mi">0</span><span class="p">));</span><span class="w"></span>
<span class="w">        </span><span class="n">Arcade</span><span class="p">.</span><span class="n">axis</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="w"> </span><span class="n">digitalRead</span><span class="p">(</span><span class="n">P2_UP</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="mi">-1</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="p">(</span><span class="n">digitalRead</span><span class="p">(</span><span class="n">P2_DOWN</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="mi">0</span><span class="p">));</span><span class="w"></span>

<span class="w">        </span><span class="c1">// also use buttons for the axes cuz unity is a derp</span>
<span class="w">        </span><span class="n">Arcade</span><span class="p">.</span><span class="n">button</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">digitalRead</span><span class="p">(</span><span class="n">P1_UP</span><span class="p">));</span><span class="w"></span>
<span class="w">        </span><span class="n">Arcade</span><span class="p">.</span><span class="n">button</span><span class="p">(</span><span class="mi">7</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">digitalRead</span><span class="p">(</span><span class="n">P1_RIGHT</span><span class="p">));</span><span class="w"></span>
<span class="w">        </span><span class="n">Arcade</span><span class="p">.</span><span class="n">button</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">digitalRead</span><span class="p">(</span><span class="n">P1_DOWN</span><span class="p">));</span><span class="w"></span>
<span class="w">        </span><span class="n">Arcade</span><span class="p">.</span><span class="n">button</span><span class="p">(</span><span class="mi">9</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">digitalRead</span><span class="p">(</span><span class="n">P1_LEFT</span><span class="p">));</span><span class="w"></span>
<span class="w">        </span><span class="n">Arcade</span><span class="p">.</span><span class="n">button</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">digitalRead</span><span class="p">(</span><span class="n">P2_UP</span><span class="p">));</span><span class="w"></span>
<span class="w">        </span><span class="n">Arcade</span><span class="p">.</span><span class="n">button</span><span class="p">(</span><span class="mi">11</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">digitalRead</span><span class="p">(</span><span class="n">P2_RIGHT</span><span class="p">));</span><span class="w"></span>
<span class="w">        </span><span class="n">Arcade</span><span class="p">.</span><span class="n">button</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">digitalRead</span><span class="p">(</span><span class="n">P2_DOWN</span><span class="p">));</span><span class="w"></span>
<span class="w">        </span><span class="n">Arcade</span><span class="p">.</span><span class="n">button</span><span class="p">(</span><span class="mi">13</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">digitalRead</span><span class="p">(</span><span class="n">P2_LEFT</span><span class="p">));</span><span class="w"></span>

<span class="w">        </span><span class="c1">// send a packet now</span>
<span class="w">        </span><span class="n">Arcade</span><span class="p">.</span><span class="n">send</span><span class="p">();</span><span class="w"></span>

<span class="w">        </span><span class="c1">// toggle our led</span>
<span class="w">        </span><span class="n">ledOn</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">!</span><span class="n">ledOn</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="n">digitalWrite</span><span class="p">(</span><span class="n">ledPin</span><span class="p">,</span><span class="w"> </span><span class="n">ledOn</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div> <p>I apologize for sloppy or incoherent code, but I was mostly figuring things out from scratch with a tight time budget, and my only goal was to get this to <strong>just work</strong>, which they thankfully did in the end!</p> <p>That’s all for now, please let me know if you run into any issues or if what I wrote here didn’t make sense! I can’t promise I can fix it but I will certainly promise to try!</p> <script src="/ruffle/ruffle.js"></script> </article> </main> <footer> <p> <span>© 2022 <a href="https://hamaluik.ca">Kenton Hamaluik</a></span> <span><a class="has-icon" href="https://blog.hamaluik.ca/feed.rss"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 256 256"><rect width="256" height="256" fill="none"></rect><path d="M48,144a64,64,0,0,1,64,64" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="16"></path><path d="M48,96A112,112,0,0,1,160,208" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="16"></path><path d="M48,48A160,160,0,0,1,208,208" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="16"></path><circle cx="52" cy="204" r="12"></circle></svg> Subscribe</a></span> </p> </footer> </body> </html>